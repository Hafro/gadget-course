<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>7 Fitting a model to data | Building models using the Gadget framework</title>
  <meta name="description" content="7 Fitting a model to data | Building models using the Gadget framework" />
  <meta name="generator" content="bookdown 0.21 and GitBook 2.6.7" />

  <meta property="og:title" content="7 Fitting a model to data | Building models using the Gadget framework" />
  <meta property="og:type" content="book" />
  
  
  
  

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="7 Fitting a model to data | Building models using the Gadget framework" />
  
  
  




  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="building-complex-gadget-models.html"/>
<link rel="next" href="defining-multi-area-models.html"/>
<script src="assets/jquery-2.2.3/jquery.min.js"></script>
<link href="assets/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="assets/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />









<script src="assets/accessible-code-block-0.0.1/empty-anchor.js"></script>
<link href="assets/anchor-sections-1.0/anchor-sections.css" rel="stylesheet" />
<script src="assets/anchor-sections-1.0/anchor-sections.js"></script>
<script src="assets/htmlwidgets-1.5.2/htmlwidgets.js"></script>
<link href="assets/datatables-css-0.0.0/datatables-crosstalk.css" rel="stylesheet" />
<script src="assets/datatables-binding-0.16/datatables.js"></script>
<link href="assets/dt-core-1.10.20/css/jquery.dataTables.min.css" rel="stylesheet" />
<link href="assets/dt-core-1.10.20/css/jquery.dataTables.extra.css" rel="stylesheet" />
<script src="assets/dt-core-1.10.20/js/jquery.dataTables.min.js"></script>
<link href="assets/crosstalk-1.1.0.1/css/crosstalk.css" rel="stylesheet" />
<script src="assets/crosstalk-1.1.0.1/js/crosstalk.min.js"></script>


<style type="text/css">
code.sourceCode > span { display: inline-block; line-height: 1.25; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<li><strong><a href="./">Building Gadget models</a></strong></li>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="index.html"><a href="index.html"><i class="fa fa-check"></i><b>1</b> About this course</a><ul>
<li class="chapter" data-level="1.1" data-path="index.html"><a href="index.html#course-objectives"><i class="fa fa-check"></i><b>1.1</b> Course objectives</a></li>
<li class="chapter" data-level="1.2" data-path="index.html"><a href="index.html#your-a-priori-homework"><i class="fa fa-check"></i><b>1.2</b> Your a priori homework</a></li>
<li class="chapter" data-level="1.3" data-path="index.html"><a href="index.html#reading-material"><i class="fa fa-check"></i><b>1.3</b> Reading material</a></li>
</ul></li>
<li class="chapter" data-level="2" data-path="general-context-of-gadget.html"><a href="general-context-of-gadget.html"><i class="fa fa-check"></i><b>2</b> General context of Gadget</a><ul>
<li class="chapter" data-level="2.1" data-path="general-context-of-gadget.html"><a href="general-context-of-gadget.html#gadget-a-toolbox-for-fisheries-stock-assessments"><i class="fa fa-check"></i><b>2.1</b> Gadget – a toolbox for fisheries stock assessments</a></li>
<li class="chapter" data-level="2.2" data-path="general-context-of-gadget.html"><a href="general-context-of-gadget.html#description-of-gadget"><i class="fa fa-check"></i><b>2.2</b> Description of Gadget</a></li>
<li class="chapter" data-level="2.3" data-path="general-context-of-gadget.html"><a href="general-context-of-gadget.html#this-course"><i class="fa fa-check"></i><b>2.3</b> This course</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html"><i class="fa fa-check"></i><b>3</b> Introduction to Tidyverse</a><ul>
<li class="chapter" data-level="3.1" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#idealogy-behind-r-for-data-science"><i class="fa fa-check"></i><b>3.1</b> Idealogy behind R for Data Science</a></li>
<li class="chapter" data-level="3.2" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#the-foundation-tibbles-tidy-data-and-piping"><i class="fa fa-check"></i><b>3.2</b> The foundation: tibbles, tidy data, and piping</a><ul>
<li class="chapter" data-level="3.2.1" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#tibbles"><i class="fa fa-check"></i><b>3.2.1</b> Tibbles</a></li>
</ul></li>
<li class="chapter" data-level="3.3" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#tidy-data"><i class="fa fa-check"></i><b>3.3</b> Tidy data</a><ul>
<li class="chapter" data-level="3.3.1" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#piping"><i class="fa fa-check"></i><b>3.3.1</b> Piping</a></li>
</ul></li>
<li class="chapter" data-level="3.4" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#the-power-of-tidyverse-all-you-need-in-a-handful-of-functions"><i class="fa fa-check"></i><b>3.4</b> The power of tidyverse: all you need in a handful of functions</a></li>
<li class="chapter" data-level="3.5" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#plotting-in-tidyverse"><i class="fa fa-check"></i><b>3.5</b> Plotting in tidyverse</a><ul>
<li class="chapter" data-level="3.5.1" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#ggplot-key-components"><i class="fa fa-check"></i><b>3.5.1</b> ggplot: Key components</a></li>
<li class="chapter" data-level="3.5.2" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#aesthetic"><i class="fa fa-check"></i><b>3.5.2</b> aesthetic</a></li>
<li class="chapter" data-level="3.5.3" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#facetting"><i class="fa fa-check"></i><b>3.5.3</b> Facetting</a></li>
<li class="chapter" data-level="3.5.4" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#adding-layers"><i class="fa fa-check"></i><b>3.5.4</b> Adding layers</a></li>
<li class="chapter" data-level="3.5.5" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#add-a-line-to-a-scatterplot"><i class="fa fa-check"></i><b>3.5.5</b> Add a line to a scatterplot</a></li>
</ul></li>
<li class="chapter" data-level="3.6" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#statistical-summary-graphs"><i class="fa fa-check"></i><b>3.6</b> Statistical summary graphs</a></li>
<li class="chapter" data-level="3.7" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#other-statistical-summaries"><i class="fa fa-check"></i><b>3.7</b> Other statistical summaries</a></li>
<li class="chapter" data-level="3.8" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#some-controls"><i class="fa fa-check"></i><b>3.8</b> Some controls</a><ul>
<li class="chapter" data-level="3.8.1" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#labels"><i class="fa fa-check"></i><b>3.8.1</b> labels</a></li>
<li class="chapter" data-level="3.8.2" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#legend-position"><i class="fa fa-check"></i><b>3.8.2</b> Legend position</a></li>
<li class="chapter" data-level="3.8.3" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#breaks"><i class="fa fa-check"></i><b>3.8.3</b> breaks</a></li>
<li class="chapter" data-level="3.8.4" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#limits"><i class="fa fa-check"></i><b>3.8.4</b> limits</a></li>
</ul></li>
<li class="chapter" data-level="3.9" data-path="introduction-to-tidyverse.html"><a href="introduction-to-tidyverse.html#further-readings"><i class="fa fa-check"></i><b>3.9</b> Further readings</a></li>
</ul></li>
<li class="chapter" data-level="4" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html"><i class="fa fa-check"></i><b>4</b> Getting started with the Gadget framework</a><ul>
<li class="chapter" data-level="4.1" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#what-is-rgadget"><i class="fa fa-check"></i><b>4.1</b> What is Rgadget?</a></li>
<li class="chapter" data-level="4.2" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#using-rgadget"><i class="fa fa-check"></i><b>4.2</b> Using Rgadget</a></li>
<li class="chapter" data-level="4.3" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#creating-model-input-files"><i class="fa fa-check"></i><b>4.3</b> Creating model input files</a><ul>
<li class="chapter" data-level="4.3.1" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#time-file"><i class="fa fa-check"></i><b>4.3.1</b> Time file</a></li>
<li class="chapter" data-level="4.3.2" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#area-file"><i class="fa fa-check"></i><b>4.3.2</b> Area file</a></li>
<li class="chapter" data-level="4.3.3" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#stockfiles"><i class="fa fa-check"></i><b>4.3.3</b> Stockfiles</a></li>
</ul></li>
<li class="chapter" data-level="4.4" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#starting-a-simulation"><i class="fa fa-check"></i><b>4.4</b> Starting a simulation</a></li>
<li class="chapter" data-level="4.5" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#gadget-variables"><i class="fa fa-check"></i><b>4.5</b> Gadget variables</a></li>
<li class="chapter" data-level="4.6" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#predation"><i class="fa fa-check"></i><b>4.6</b> Predation</a></li>
<li class="chapter" data-level="4.7" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#fleet-operations"><i class="fa fa-check"></i><b>4.7</b> Fleet operations</a><ul>
<li class="chapter" data-level="4.7.1" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#excercise"><i class="fa fa-check"></i><b>4.7.1</b> Excercise</a></li>
</ul></li>
<li class="chapter" data-level="4.8" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#recruitment"><i class="fa fa-check"></i><b>4.8</b> Recruitment</a><ul>
<li class="chapter" data-level="4.8.1" data-path="getting-started-with-the-gadget-framework.html"><a href="getting-started-with-the-gadget-framework.html#exercise-1"><i class="fa fa-check"></i><b>4.8.1</b> Exercise</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="5" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html"><i class="fa fa-check"></i><b>5</b> Defining stock interations</a><ul>
<li class="chapter" data-level="5.1" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#fish-recruits-into-a-stock"><i class="fa fa-check"></i><b>5.1</b> Fish recruits into a stock</a><ul>
<li class="chapter" data-level="5.1.1" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#excercise-1"><i class="fa fa-check"></i><b>5.1.1</b> Excercise</a></li>
</ul></li>
<li class="chapter" data-level="5.2" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#spawning"><i class="fa fa-check"></i><b>5.2</b> Spawning</a><ul>
<li class="chapter" data-level="5.2.1" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#time-variables"><i class="fa fa-check"></i><b>5.2.1</b> Time variables</a></li>
<li class="chapter" data-level="5.2.2" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#excercise-2"><i class="fa fa-check"></i><b>5.2.2</b> Excercise</a></li>
</ul></li>
<li class="chapter" data-level="5.3" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#consumption"><i class="fa fa-check"></i><b>5.3</b> Consumption</a><ul>
<li class="chapter" data-level="5.3.1" data-path="defining-stock-interations.html"><a href="defining-stock-interations.html#excercise-3"><i class="fa fa-check"></i><b>5.3.1</b> Excercise</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="6" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html"><i class="fa fa-check"></i><b>6</b> Building complex Gadget models</a><ul>
<li class="chapter" data-level="6.1" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#defining-growth"><i class="fa fa-check"></i><b>6.1</b> Defining growth</a><ul>
<li class="chapter" data-level="6.1.1" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#growth"><i class="fa fa-check"></i><b>6.1.1</b> Growth</a></li>
</ul></li>
<li class="chapter" data-level="6.2" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#ling-stock-assessment-in-icelandic-waters"><i class="fa fa-check"></i><b>6.2</b> Ling stock assessment in Icelandic waters</a></li>
<li class="chapter" data-level="6.3" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#model-initiation"><i class="fa fa-check"></i><b>6.3</b> Model initiation</a><ul>
<li class="chapter" data-level="6.3.1" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#maturation-as-multi-stock-models"><i class="fa fa-check"></i><b>6.3.1</b> Maturation as multi-‘stock’ models</a></li>
<li class="chapter" data-level="6.3.2" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#initial-conditions"><i class="fa fa-check"></i><b>6.3.2</b> Initial conditions</a></li>
<li class="chapter" data-level="6.3.3" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#renewal"><i class="fa fa-check"></i><b>6.3.3</b> Renewal</a></li>
<li class="chapter" data-level="6.3.4" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#reference-weight"><i class="fa fa-check"></i><b>6.3.4</b> Reference Weight</a></li>
<li class="chapter" data-level="6.3.5" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#is-fished-eaten"><i class="fa fa-check"></i><b>6.3.5</b> Is fished / eaten</a></li>
<li class="chapter" data-level="6.3.6" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#set-up-fleets-using-catch-or-effort-data"><i class="fa fa-check"></i><b>6.3.6</b> Set up fleets using catch or effort data</a></li>
</ul></li>
<li class="chapter" data-level="6.4" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#run-the-simulation-using-pre-determined-parameters"><i class="fa fa-check"></i><b>6.4</b> Run the simulation using pre-determined parameters</a></li>
<li class="chapter" data-level="6.5" data-path="building-complex-gadget-models.html"><a href="building-complex-gadget-models.html#talking-points"><i class="fa fa-check"></i><b>6.5</b> Talking points</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html"><i class="fa fa-check"></i><b>7</b> Fitting a model to data</a><ul>
<li class="chapter" data-level="7.1" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#introducing-likelihood-functions"><i class="fa fa-check"></i><b>7.1</b> Introducing likelihood functions</a></li>
<li class="chapter" data-level="7.2" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#incorporating-data-ling-case-study-cont."><i class="fa fa-check"></i><b>7.2</b> Incorporating data (Ling case study cont.)</a><ul>
<li class="chapter" data-level="7.2.1" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#exercise-3"><i class="fa fa-check"></i><b>7.2.1</b> Exercise</a></li>
</ul></li>
<li class="chapter" data-level="7.3" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#setting-up-likelihood-components"><i class="fa fa-check"></i><b>7.3</b> Setting up likelihood components</a><ul>
<li class="chapter" data-level="7.3.1" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#setting-up-survey-indices"><i class="fa fa-check"></i><b>7.3.1</b> Setting up survey indices</a></li>
<li class="chapter" data-level="7.3.2" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#penalty-functions"><i class="fa fa-check"></i><b>7.3.2</b> Penalty functions</a></li>
</ul></li>
<li class="chapter" data-level="7.4" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#fitting-a-gadget-model-to-data"><i class="fa fa-check"></i><b>7.4</b> Fitting a Gadget model to data</a><ul>
<li class="chapter" data-level="7.4.1" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#create-starting-values"><i class="fa fa-check"></i><b>7.4.1</b> Create starting values</a></li>
</ul></li>
<li class="chapter" data-level="7.5" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#set-optimisation-routine"><i class="fa fa-check"></i><b>7.5</b> Set optimisation routine</a></li>
<li class="chapter" data-level="7.6" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#using-the-iterative-reweighting-function-to-fit-a-gadget-statistical-model"><i class="fa fa-check"></i><b>7.6</b> Using the iterative reweighting function to fit a Gadget statistical model</a></li>
<li class="chapter" data-level="7.7" data-path="fitting-a-model-to-data.html"><a href="fitting-a-model-to-data.html#visualize-gadget-statistical-model-fit"><i class="fa fa-check"></i><b>7.7</b> Visualize Gadget statistical model fit</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="defining-multi-area-models.html"><a href="defining-multi-area-models.html"><i class="fa fa-check"></i><b>8</b> Defining multi area models</a><ul>
<li class="chapter" data-level="8.1" data-path="defining-multi-area-models.html"><a href="defining-multi-area-models.html#alternate-structures-multiple-areas"><i class="fa fa-check"></i><b>8.1</b> Alternate structures: multiple areas</a><ul>
<li class="chapter" data-level="8.1.1" data-path="defining-multi-area-models.html"><a href="defining-multi-area-models.html#migration"><i class="fa fa-check"></i><b>8.1.1</b> Migration</a></li>
<li class="chapter" data-level="8.1.2" data-path="defining-multi-area-models.html"><a href="defining-multi-area-models.html#using-data-from-multiple-areas"><i class="fa fa-check"></i><b>8.1.2</b> Using data from multiple areas</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="9" data-path="marine-mammals.html"><a href="marine-mammals.html"><i class="fa fa-check"></i><b>9</b> Marine mammals</a></li>
<li class="chapter" data-level="10" data-path="setting-up-a-model-for-a-hypothetical-whale-stock.html"><a href="setting-up-a-model-for-a-hypothetical-whale-stock.html"><i class="fa fa-check"></i><b>10</b> Setting up a model for a hypothetical whale stock</a><ul>
<li class="chapter" data-level="10.0.1" data-path="setting-up-a-model-for-a-hypothetical-whale-stock.html"><a href="setting-up-a-model-for-a-hypothetical-whale-stock.html#run-gadget-and-set-initial-parameters"><i class="fa fa-check"></i><b>10.0.1</b> Run Gadget and set initial parameters</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html"><i class="fa fa-check"></i><b>11</b> Processing input data with MFDB</a><ul>
<li class="chapter" data-level="11.1" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#working-with-data"><i class="fa fa-check"></i><b>11.1</b> Working with data</a></li>
<li class="chapter" data-level="11.2" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#description-of-the-mfdb-system"><i class="fa fa-check"></i><b>11.2</b> Description of the MFDB system</a><ul>
<li class="chapter" data-level="11.2.1" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#installing-mfdb"><i class="fa fa-check"></i><b>11.2.1</b> Installing MFDB</a></li>
</ul></li>
<li class="chapter" data-level="11.3" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#importing-data"><i class="fa fa-check"></i><b>11.3</b> Importing data</a><ul>
<li class="chapter" data-level="11.3.1" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#connect-to-database"><i class="fa fa-check"></i><b>11.3.1</b> Connect to database</a></li>
<li class="chapter" data-level="11.3.2" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#defining-taxonomies"><i class="fa fa-check"></i><b>11.3.2</b> Defining taxonomies</a></li>
<li class="chapter" data-level="11.3.3" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#define-areas-divisions"><i class="fa fa-check"></i><b>11.3.3</b> Define areas &amp; divisions</a></li>
<li class="chapter" data-level="11.3.4" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#define-sampling-types"><i class="fa fa-check"></i><b>11.3.4</b> Define sampling types</a></li>
<li class="chapter" data-level="11.3.5" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#define-vessel-taxonomy"><i class="fa fa-check"></i><b>11.3.5</b> Define vessel taxonomy</a></li>
<li class="chapter" data-level="11.3.6" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#define-tow-taxonomy"><i class="fa fa-check"></i><b>11.3.6</b> Define tow taxonomy</a></li>
</ul></li>
<li class="chapter" data-level="11.4" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#importing-data-1"><i class="fa fa-check"></i><b>11.4</b> Importing data</a><ul>
<li class="chapter" data-level="11.4.1" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#import-temperature-data"><i class="fa fa-check"></i><b>11.4.1</b> Import temperature data</a></li>
<li class="chapter" data-level="11.4.2" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#importing-surveycommercial-samples"><i class="fa fa-check"></i><b>11.4.2</b> Importing survey/commercial samples</a></li>
<li class="chapter" data-level="11.4.3" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#import-stomach-survey"><i class="fa fa-check"></i><b>11.4.3</b> Import stomach survey</a></li>
</ul></li>
<li class="chapter" data-level="11.5" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#querying-data"><i class="fa fa-check"></i><b>11.5</b> Querying data</a></li>
<li class="chapter" data-level="11.6" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#uploading-the-datras-database-to-mfdb"><i class="fa fa-check"></i><b>11.6</b> Uploading the DATRAS database to MFDB</a></li>
<li class="chapter" data-level="11.7" data-path="processing-input-data-with-mfdb.html"><a href="processing-input-data-with-mfdb.html#dumping-restoring-a-db"><i class="fa fa-check"></i><b>11.7</b> Dumping / Restoring a DB</a></li>
</ul></li>
<li class="appendix"><span><b>Appendix</b></span></li>
<li class="chapter" data-level="A" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html"><i class="fa fa-check"></i><b>A</b> Installing Gadget from source</a><ul>
<li class="chapter" data-level="A.1" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#command-line-version"><i class="fa fa-check"></i><b>A.1</b> Command line version</a><ul>
<li class="chapter" data-level="A.1.1" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#linux"><i class="fa fa-check"></i><b>A.1.1</b> Linux</a></li>
<li class="chapter" data-level="A.1.2" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#mac"><i class="fa fa-check"></i><b>A.1.2</b> Mac</a></li>
<li class="chapter" data-level="A.1.3" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#windows"><i class="fa fa-check"></i><b>A.1.3</b> Windows</a></li>
</ul></li>
<li class="chapter" data-level="A.2" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#download-compile-and-install"><i class="fa fa-check"></i><b>A.2</b> Download, compile and install</a><ul>
<li class="chapter" data-level="A.2.1" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#standard-procedure"><i class="fa fa-check"></i><b>A.2.1</b> Standard procedure</a></li>
<li class="chapter" data-level="A.2.2" data-path="installing-gadget-from-source.html"><a href="installing-gadget-from-source.html#recommended-via-git"><i class="fa fa-check"></i><b>A.2.2</b> Recommended: via Git</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="B" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html"><i class="fa fa-check"></i><b>B</b> Troubleshooting Gadget models</a><ul>
<li class="chapter" data-level="B.0.1" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#file-data-gadget-cannot-be-found"><i class="fa fa-check"></i><b>B.0.1</b> File / data / Gadget cannot be found</a></li>
<li class="chapter" data-level="B.0.2" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#fleet-data-likelihood-problems"><i class="fa fa-check"></i><b>B.0.2</b> Fleet / Data / Likelihood problems</a></li>
<li class="chapter" data-level="B.0.3" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#starting-value-is-outside-the-bounds-of-the-parameter"><i class="fa fa-check"></i><b>B.0.3</b> Starting value is outside the bounds of the parameter</a></li>
<li class="chapter" data-level="B.0.4" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#update-gadget-and-rgadget-restart-the-rsession"><i class="fa fa-check"></i><b>B.0.4</b> Update Gadget and Rgadget, restart the Rsession</a></li>
<li class="chapter" data-level="B.1" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#list-of-known-gadget-quirks"><i class="fa fa-check"></i><b>B.1</b> List of known Gadget quirks</a></li>
<li class="chapter" data-level="B.2" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#gadget-is-working-properly-but-results-are-strange"><i class="fa fa-check"></i><b>B.2</b> Gadget is working properly, but results are strange</a><ul>
<li class="chapter" data-level="B.2.1" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#programming-errors"><i class="fa fa-check"></i><b>B.2.1</b> Programming errors</a></li>
<li class="chapter" data-level="B.2.2" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#old-files-hanging-around-in-the-gadget-model-directory"><i class="fa fa-check"></i><b>B.2.2</b> Old files hanging around in the Gadget model directory</a></li>
<li class="chapter" data-level="B.2.3" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#gadget-iterative-gives-errors"><i class="fa fa-check"></i><b>B.2.3</b> Gadget iterative gives errors</a></li>
<li class="chapter" data-level="B.2.4" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#the-gadget-working-directory-is-incorporating-files-from-another-gadget-model"><i class="fa fa-check"></i><b>B.2.4</b> The Gadget working directory is incorporating files from another Gadget model</a></li>
<li class="chapter" data-level="B.2.5" data-path="troubleshooting-gadget-models.html"><a href="troubleshooting-gadget-models.html#your-model-is-not-good"><i class="fa fa-check"></i><b>B.2.5</b> Your model is not good</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="C" data-path="references.html"><a href="references.html"><i class="fa fa-check"></i><b>C</b> References</a></li>
</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Building models using the Gadget framework</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="fitting-a-model-to-data" class="section level1">
<h1><span class="header-section-number">7</span> Fitting a model to data</h1>
<div id="introducing-likelihood-functions" class="section level2">
<h2><span class="header-section-number">7.1</span> Introducing likelihood functions</h2>
<p>In Gadget, a likelihood function is specified by supplying likelihood components within the likelihood
file, which is referred to by the main file. Individual likelihood component scores are summed together
after being multiplied by weights to form a total likelihood score, and each likelihood score is defined by the type of likelihood component specified.
Component types define both the kind of data and likelihood function being calculated for that component.
Although we refer to ‘likelihood scores’ throughout this description, it should be kept in mind that these
are more accurately sums of log likelihoods, so that the objective function used for model fitting attempts to minimize the total likelihood score.</p>
</div>
<div id="incorporating-data-ling-case-study-cont." class="section level2">
<h2><span class="header-section-number">7.2</span> Incorporating data (Ling case study cont.)</h2>
<p>In introducing likelihood components, we will first go through those used within the ling example
in detail, but only mention the other types as they follow similar patterns of implementation.
To use Rgadget to set up likelihood files, the first consideration that should be made is what
data are available that would be useful for creating a likelihood component. These have been
provided for you here: in the ‘data_provided’ folder, you will find catch data (as introduced
with the fleets), as well as survey indices, catch distribution, and ‘stock’ distribution data.
Catch distributions include numbers at length as well as numbers at age and length by fleet.
These therefore include both biological samples in fishery data as well as survey data.
Each length- or age-bin has been defined as having the lower bound only inclusive, except that
the lower bound of the smallest bin and the upper bound of the largest bin are open-ended to
include all values lower or higher, respectively. These numbers are then used within Gadget
to form proportions among defined bins, which are compared to the same proportions among the
same bins simulated in the model. Stock distribution data are numbers within each stock, which
for ling is immature or mature, but could for example be gender-specific stocks. Stock distribution
numbers are similarly used to form proportions within Gadget.</p>
<p>As we saw when incorporating catch data into fleet files (day 2), certain attributes need to
be present in order for the proper and internally consistent Gadget aggregation files to be
created alongside these data files. For catch and stock distribution data, these include area,
length, and age aggregations. Even when there is only a single bin, these aggregations need
to be specified. For example a single area and a single age group is needed for length
distributions, in addition to the length bins. Note that bins need not be evenly distributed
across the total length range; instead they are highly flexible and can be specified as any
grouping. Therefore the user should be careful to ensure that the definitions make sense and
that bins do not overlap. In our example below, we show how to add those necessary attributes,
although in reality to do this we also use another R package named ‘mfdb’ that is aimed at
database management and data extraction [more on this in day 5].</p>
<div class="sourceCode" id="cb256"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb256-1"><a href="fitting-a-model-to-data.html#cb256-1"></a><span class="kw">library</span>(tidyverse)</span>
<span id="cb256-2"><a href="fitting-a-model-to-data.html#cb256-2"></a><span class="kw">library</span>(Rgadget)</span>
<span id="cb256-3"><a href="fitting-a-model-to-data.html#cb256-3"></a></span>
<span id="cb256-4"><a href="fitting-a-model-to-data.html#cb256-4"></a><span class="co">#assuming you are beginning in a fresh session; this information should be in an </span></span>
<span id="cb256-5"><a href="fitting-a-model-to-data.html#cb256-5"></a><span class="co">#initialization script</span></span>
<span id="cb256-6"><a href="fitting-a-model-to-data.html#cb256-6"></a></span>
<span id="cb256-7"><a href="fitting-a-model-to-data.html#cb256-7"></a>base_dir &lt;-<span class="st"> &#39;ling_model&#39;</span></span>
<span id="cb256-8"><a href="fitting-a-model-to-data.html#cb256-8"></a>vers &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&#39;01-base&#39;</span>)</span>
<span id="cb256-9"><a href="fitting-a-model-to-data.html#cb256-9"></a>gd &lt;-<span class="st"> </span><span class="kw">normalizePath</span>(<span class="kw">gadget.variant.dir</span>(<span class="kw">sprintf</span>(<span class="kw">paste0</span>(<span class="st">&quot;%s/&quot;</span>,vers),base_dir)))</span>
<span id="cb256-10"><a href="fitting-a-model-to-data.html#cb256-10"></a></span>
<span id="cb256-11"><a href="fitting-a-model-to-data.html#cb256-11"></a>ling.imm &lt;-<span class="st"> </span><span class="kw">gadgetstock</span>(<span class="st">&#39;lingimm&#39;</span>,gd)</span>
<span id="cb256-12"><a href="fitting-a-model-to-data.html#cb256-12"></a>ling.mat &lt;-<span class="st"> </span><span class="kw">gadgetstock</span>(<span class="st">&#39;lingmat&#39;</span>,gd)</span>
<span id="cb256-13"><a href="fitting-a-model-to-data.html#cb256-13"></a>area_file &lt;-<span class="st"> </span><span class="kw">read.gadget.file</span>(gd, <span class="st">&#39;Modelfiles/area&#39;</span>)</span>
<span id="cb256-14"><a href="fitting-a-model-to-data.html#cb256-14"></a></span>
<span id="cb256-15"><a href="fitting-a-model-to-data.html#cb256-15"></a>minage &lt;-<span class="st"> </span>ling.imm[[<span class="dv">1</span>]]<span class="op">$</span>minage</span>
<span id="cb256-16"><a href="fitting-a-model-to-data.html#cb256-16"></a>maxage &lt;-<span class="st"> </span>ling.mat[[<span class="dv">1</span>]]<span class="op">$</span>maxage</span>
<span id="cb256-17"><a href="fitting-a-model-to-data.html#cb256-17"></a>maxlength &lt;-<span class="st"> </span>ling.mat[[<span class="dv">1</span>]]<span class="op">$</span>maxlength </span>
<span id="cb256-18"><a href="fitting-a-model-to-data.html#cb256-18"></a>minlength &lt;-<span class="st"> </span>ling.imm[[<span class="dv">1</span>]]<span class="op">$</span>minlength</span>
<span id="cb256-19"><a href="fitting-a-model-to-data.html#cb256-19"></a>dl &lt;-<span class="st"> </span>ling.imm[[<span class="dv">1</span>]]<span class="op">$</span>dl</span>
<span id="cb256-20"><a href="fitting-a-model-to-data.html#cb256-20"></a></span>
<span id="cb256-21"><a href="fitting-a-model-to-data.html#cb256-21"></a></span>
<span id="cb256-22"><a href="fitting-a-model-to-data.html#cb256-22"></a></span>
<span id="cb256-23"><a href="fitting-a-model-to-data.html#cb256-23"></a>create_intervals &lt;-<span class="st">  </span><span class="cf">function</span> (prefix, vect) {</span>
<span id="cb256-24"><a href="fitting-a-model-to-data.html#cb256-24"></a>  </span>
<span id="cb256-25"><a href="fitting-a-model-to-data.html#cb256-25"></a>  x&lt;-</span>
<span id="cb256-26"><a href="fitting-a-model-to-data.html#cb256-26"></a><span class="st">    </span><span class="kw">structure</span>(vect[<span class="dv">1</span><span class="op">:</span>(<span class="kw">length</span>(vect)<span class="op">-</span><span class="dv">1</span>)], <span class="dt">names =</span> <span class="kw">paste0</span>(prefix, vect[<span class="dv">1</span><span class="op">:</span>(<span class="kw">length</span>(vect)<span class="op">-</span><span class="dv">1</span>)])) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb256-27"><a href="fitting-a-model-to-data.html#cb256-27"></a><span class="st">    </span><span class="kw">as.list</span>(.) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb256-28"><a href="fitting-a-model-to-data.html#cb256-28"></a><span class="st">    </span>purrr<span class="op">::</span><span class="kw">map</span>(<span class="op">~</span><span class="kw">structure</span>(<span class="kw">seq</span>(.,vect[<span class="op">-</span><span class="dv">1</span>][<span class="kw">which</span>(vect[<span class="dv">1</span><span class="op">:</span>(<span class="kw">length</span>(vect)<span class="op">-</span><span class="dv">1</span>)]<span class="op">==</span>.)],<span class="dv">1</span>)[<span class="op">-</span><span class="kw">length</span>(<span class="kw">seq</span>(.,vect[<span class="op">-</span><span class="dv">1</span>][<span class="kw">which</span>(vect[<span class="dv">1</span><span class="op">:</span>(<span class="kw">length</span>(vect)<span class="op">-</span><span class="dv">1</span>)]<span class="op">==</span>.)],<span class="dv">1</span>))], </span>
<span id="cb256-29"><a href="fitting-a-model-to-data.html#cb256-29"></a>                          <span class="dt">min =</span> ., </span>
<span id="cb256-30"><a href="fitting-a-model-to-data.html#cb256-30"></a>                          <span class="dt">max =</span> vect[<span class="op">-</span><span class="dv">1</span>][<span class="kw">which</span>(vect[<span class="dv">1</span><span class="op">:</span>(<span class="kw">length</span>(vect)<span class="op">-</span><span class="dv">1</span>)]<span class="op">==</span>.)]))</span>
<span id="cb256-31"><a href="fitting-a-model-to-data.html#cb256-31"></a>  </span>
<span id="cb256-32"><a href="fitting-a-model-to-data.html#cb256-32"></a>  x[[<span class="kw">length</span>(x)]] &lt;-<span class="st"> </span><span class="kw">c</span>(x[[<span class="kw">length</span>(x)]], <span class="kw">attributes</span>(x[[<span class="kw">length</span>(x)]])<span class="op">$</span>max) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb256-33"><a href="fitting-a-model-to-data.html#cb256-33"></a><span class="st">    </span><span class="kw">structure</span>(., </span>
<span id="cb256-34"><a href="fitting-a-model-to-data.html#cb256-34"></a>              <span class="dt">min =</span> <span class="kw">min</span>(.), </span>
<span id="cb256-35"><a href="fitting-a-model-to-data.html#cb256-35"></a>              <span class="dt">max =</span> <span class="kw">max</span>(.))</span>
<span id="cb256-36"><a href="fitting-a-model-to-data.html#cb256-36"></a>  </span>
<span id="cb256-37"><a href="fitting-a-model-to-data.html#cb256-37"></a>  </span>
<span id="cb256-38"><a href="fitting-a-model-to-data.html#cb256-38"></a>  <span class="kw">return</span>(x)</span>
<span id="cb256-39"><a href="fitting-a-model-to-data.html#cb256-39"></a>}</span>
<span id="cb256-40"><a href="fitting-a-model-to-data.html#cb256-40"></a><span class="co">#just to see what this function does:</span></span>
<span id="cb256-41"><a href="fitting-a-model-to-data.html#cb256-41"></a><span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)) <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="dv">1</span><span class="op">:</span><span class="dv">3</span>]</span></code></pre></div>
<pre><code>## $len20
## [1] 20 21 22 23
## attr(,&quot;min&quot;)
## [1] 20
## attr(,&quot;max&quot;)
## [1] 24
## 
## $len24
## [1] 24 25 26 27
## attr(,&quot;min&quot;)
## [1] 24
## attr(,&quot;max&quot;)
## [1] 28
## 
## $len28
## [1] 28 29 30 31
## attr(,&quot;min&quot;)
## [1] 28
## attr(,&quot;max&quot;)
## [1] 32</code></pre>
<div class="sourceCode" id="cb258"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb258-1"><a href="fitting-a-model-to-data.html#cb258-1"></a><span class="co">#catch distribution data available:</span></span>
<span id="cb258-2"><a href="fitting-a-model-to-data.html#cb258-2"></a><span class="co">#length distributions do not regard age bins</span></span>
<span id="cb258-3"><a href="fitting-a-model-to-data.html#cb258-3"></a>ldist.surv &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/ldist_sur.csv&#39;</span>),</span>
<span id="cb258-4"><a href="fitting-a-model-to-data.html#cb258-4"></a>                        <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb258-5"><a href="fitting-a-model-to-data.html#cb258-5"></a>                        <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb258-6"><a href="fitting-a-model-to-data.html#cb258-6"></a>                        <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;all&#39;</span>,<span class="kw">seq</span>(minage, maxage, maxage<span class="op">-</span>minage))</span>
<span id="cb258-7"><a href="fitting-a-model-to-data.html#cb258-7"></a>)</span>
<span id="cb258-8"><a href="fitting-a-model-to-data.html#cb258-8"></a>ldist.lln &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/ldist_lln.csv&#39;</span>),</span>
<span id="cb258-9"><a href="fitting-a-model-to-data.html#cb258-9"></a>                       <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb258-10"><a href="fitting-a-model-to-data.html#cb258-10"></a>                       <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb258-11"><a href="fitting-a-model-to-data.html#cb258-11"></a>                       <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;all&#39;</span>,<span class="kw">seq</span>(minage, maxage, maxage<span class="op">-</span>minage))</span>
<span id="cb258-12"><a href="fitting-a-model-to-data.html#cb258-12"></a>)</span>
<span id="cb258-13"><a href="fitting-a-model-to-data.html#cb258-13"></a>ldist.bmt &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/ldist_bmt.csv&#39;</span>),</span>
<span id="cb258-14"><a href="fitting-a-model-to-data.html#cb258-14"></a>                       <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb258-15"><a href="fitting-a-model-to-data.html#cb258-15"></a>                       <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb258-16"><a href="fitting-a-model-to-data.html#cb258-16"></a>                       <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;all&#39;</span>,<span class="kw">seq</span>(minage, maxage, maxage<span class="op">-</span>minage))</span>
<span id="cb258-17"><a href="fitting-a-model-to-data.html#cb258-17"></a>)</span>
<span id="cb258-18"><a href="fitting-a-model-to-data.html#cb258-18"></a>ldist.gil &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/ldist_gil.csv&#39;</span>),</span>
<span id="cb258-19"><a href="fitting-a-model-to-data.html#cb258-19"></a>                       <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb258-20"><a href="fitting-a-model-to-data.html#cb258-20"></a>                       <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb258-21"><a href="fitting-a-model-to-data.html#cb258-21"></a>                       <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;all&#39;</span>,<span class="kw">seq</span>(minage, maxage, maxage<span class="op">-</span>minage))</span>
<span id="cb258-22"><a href="fitting-a-model-to-data.html#cb258-22"></a>)</span>
<span id="cb258-23"><a href="fitting-a-model-to-data.html#cb258-23"></a></span>
<span id="cb258-24"><a href="fitting-a-model-to-data.html#cb258-24"></a><span class="kw">attributes</span>(ldist.surv) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb258-25"><a href="fitting-a-model-to-data.html#cb258-25"></a><span class="st">  </span>purrr<span class="op">::</span><span class="kw">map</span>(head)</span></code></pre></div>
<pre><code>## $names
## [1] &quot;year&quot;   &quot;step&quot;   &quot;area&quot;   &quot;age&quot;    &quot;length&quot; &quot;number&quot;
## 
## $class
## [1] &quot;spec_tbl_df&quot; &quot;tbl_df&quot;      &quot;tbl&quot;         &quot;data.frame&quot; 
## 
## $row.names
## [1] 1 2 3 4 5 6
## 
## $spec
## $spec$cols
## $spec$cols$year
## &lt;collector_double&gt;
## 
## $spec$cols$step
## &lt;collector_double&gt;
## 
## $spec$cols$area
## &lt;collector_double&gt;
## 
## $spec$cols$age
## &lt;collector_character&gt;
## 
## $spec$cols$length
## &lt;collector_character&gt;
## 
## $spec$cols$number
## &lt;collector_double&gt;
## 
## 
## $spec$default
## &lt;collector_guess&gt;
## 
## $spec$skip
## [1] 1
## 
## 
## $area
## $area$`1`
## [1] 1
## 
## 
## $length
## $length$len20
## [1] 20 21 22 23
## attr(,&quot;min&quot;)
## [1] 20
## attr(,&quot;max&quot;)
## [1] 24
## 
## $length$len24
## [1] 24 25 26 27
## attr(,&quot;min&quot;)
## [1] 24
## attr(,&quot;max&quot;)
## [1] 28
## 
## $length$len28
## [1] 28 29 30 31
## attr(,&quot;min&quot;)
## [1] 28
## attr(,&quot;max&quot;)
## [1] 32
## 
## $length$len32
## [1] 32 33 34 35
## attr(,&quot;min&quot;)
## [1] 32
## attr(,&quot;max&quot;)
## [1] 36
## 
## $length$len36
## [1] 36 37 38 39
## attr(,&quot;min&quot;)
## [1] 36
## attr(,&quot;max&quot;)
## [1] 40
## 
## $length$len40
## [1] 40 41 42 43
## attr(,&quot;min&quot;)
## [1] 40
## attr(,&quot;max&quot;)
## [1] 44
## 
## 
## $age
## $age$all3
##  [1]  3  4  5  6  7  8  9 10 11 12 13 14 15
## attr(,&quot;min&quot;)
## [1] 3
## attr(,&quot;max&quot;)
## [1] 15</code></pre>
<div class="sourceCode" id="cb260"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb260-1"><a href="fitting-a-model-to-data.html#cb260-1"></a><span class="co">#age bins needed for age-length distributions</span></span>
<span id="cb260-2"><a href="fitting-a-model-to-data.html#cb260-2"></a>aldist.surv &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/aldist_sur.csv&#39;</span>),</span>
<span id="cb260-3"><a href="fitting-a-model-to-data.html#cb260-3"></a>                         <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb260-4"><a href="fitting-a-model-to-data.html#cb260-4"></a>                         <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb260-5"><a href="fitting-a-model-to-data.html#cb260-5"></a>                         <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;age&#39;</span>,<span class="kw">c</span>(minage<span class="op">:</span><span class="dv">11</span>, maxage))</span>
<span id="cb260-6"><a href="fitting-a-model-to-data.html#cb260-6"></a>)</span>
<span id="cb260-7"><a href="fitting-a-model-to-data.html#cb260-7"></a>aldist.lln &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/aldist_lln.csv&#39;</span>),</span>
<span id="cb260-8"><a href="fitting-a-model-to-data.html#cb260-8"></a>                        <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb260-9"><a href="fitting-a-model-to-data.html#cb260-9"></a>                        <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb260-10"><a href="fitting-a-model-to-data.html#cb260-10"></a>                        <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;age&#39;</span>,<span class="kw">c</span>(minage<span class="op">:</span><span class="dv">11</span>, maxage))</span>
<span id="cb260-11"><a href="fitting-a-model-to-data.html#cb260-11"></a>)</span>
<span id="cb260-12"><a href="fitting-a-model-to-data.html#cb260-12"></a>aldist.bmt &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/aldist_bmt.csv&#39;</span>),</span>
<span id="cb260-13"><a href="fitting-a-model-to-data.html#cb260-13"></a>                        <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb260-14"><a href="fitting-a-model-to-data.html#cb260-14"></a>                        <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb260-15"><a href="fitting-a-model-to-data.html#cb260-15"></a>                        <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;age&#39;</span>,<span class="kw">c</span>(minage<span class="op">:</span><span class="dv">11</span>, maxage))</span>
<span id="cb260-16"><a href="fitting-a-model-to-data.html#cb260-16"></a>)</span>
<span id="cb260-17"><a href="fitting-a-model-to-data.html#cb260-17"></a>aldist.gil &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/aldist_gil.csv&#39;</span>),</span>
<span id="cb260-18"><a href="fitting-a-model-to-data.html#cb260-18"></a>                        <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb260-19"><a href="fitting-a-model-to-data.html#cb260-19"></a>                        <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl)),</span>
<span id="cb260-20"><a href="fitting-a-model-to-data.html#cb260-20"></a>                        <span class="dt">age =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;age&#39;</span>,<span class="kw">c</span>(minage<span class="op">:</span><span class="dv">11</span>, maxage))</span>
<span id="cb260-21"><a href="fitting-a-model-to-data.html#cb260-21"></a>)</span>
<span id="cb260-22"><a href="fitting-a-model-to-data.html#cb260-22"></a></span>
<span id="cb260-23"><a href="fitting-a-model-to-data.html#cb260-23"></a><span class="kw">attributes</span>(aldist.surv)<span class="op">$</span>age <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">head</span>(<span class="dv">3</span>)</span></code></pre></div>
<pre><code>## $age3
## [1] 3
## attr(,&quot;min&quot;)
## [1] 3
## attr(,&quot;max&quot;)
## [1] 4
## 
## $age4
## [1] 4
## attr(,&quot;min&quot;)
## [1] 4
## attr(,&quot;max&quot;)
## [1] 5
## 
## $age5
## [1] 5
## attr(,&quot;min&quot;)
## [1] 5
## attr(,&quot;max&quot;)
## [1] 6</code></pre>
<div class="sourceCode" id="cb262"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb262-1"><a href="fitting-a-model-to-data.html#cb262-1"></a><span class="co">#stock distribution data available:</span></span>
<span id="cb262-2"><a href="fitting-a-model-to-data.html#cb262-2"></a>matp.surv &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/matp_sur.csv&#39;</span>),</span>
<span id="cb262-3"><a href="fitting-a-model-to-data.html#cb262-3"></a>                       <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb262-4"><a href="fitting-a-model-to-data.html#cb262-4"></a>                       <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>,<span class="kw">seq</span>(minlength, maxlength, dl<span class="op">*</span><span class="dv">2</span>)),</span>
<span id="cb262-5"><a href="fitting-a-model-to-data.html#cb262-5"></a>                       <span class="dt">age =</span> <span class="kw">list</span>(<span class="dt">mat_ages =</span> ling.mat[[<span class="dv">1</span>]]<span class="op">$</span>minage<span class="op">:</span>ling.mat[[<span class="dv">1</span>]]<span class="op">$</span>maxage)</span>
<span id="cb262-6"><a href="fitting-a-model-to-data.html#cb262-6"></a>)</span>
<span id="cb262-7"><a href="fitting-a-model-to-data.html#cb262-7"></a></span>
<span id="cb262-8"><a href="fitting-a-model-to-data.html#cb262-8"></a><span class="co">#attributes(matp.surv)</span></span></code></pre></div>
<p>For ling, length-based indices were used by choosing 7 ‘slices’ of abundance indices across the
length range of ling observed. Index bounds are defined as above, generally inclusive of the
lower bound only, but open-ended for the smallest and largest bins. It is important to note
that only area and length attributes are included as attributes on these data frames, rather than
age, as in the distributional components. The length attribute allows <code>gadget_update</code> to recognize
these data as length-based indices, rather than age-based or acoustic indices, for example. It is
also important to keep in mind
here that each slice will have its own estimated catchability per survey (single data frame below)
and area combination (multiple areas may be within a data frame).</p>
<div class="sourceCode" id="cb263"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb263-1"><a href="fitting-a-model-to-data.html#cb263-1"></a><span class="co">#survey index data available: </span></span>
<span id="cb263-2"><a href="fitting-a-model-to-data.html#cb263-2"></a>slices &lt;-<span class="st"> </span></span>
<span id="cb263-3"><a href="fitting-a-model-to-data.html#cb263-3"></a><span class="st">  </span><span class="kw">list</span>(<span class="st">&#39;len20&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">20</span>,<span class="dv">52</span>), <span class="st">&#39;len52&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">52</span>,<span class="dv">60</span>), <span class="st">&#39;len60&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">60</span>,<span class="dv">72</span>), </span>
<span id="cb263-4"><a href="fitting-a-model-to-data.html#cb263-4"></a>       <span class="st">&#39;len72&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">72</span>,<span class="dv">80</span>), <span class="st">&#39;len80&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">80</span>,<span class="dv">92</span>), <span class="st">&#39;len92&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">92</span>,<span class="dv">100</span>), </span>
<span id="cb263-5"><a href="fitting-a-model-to-data.html#cb263-5"></a>       <span class="st">&#39;len100&#39;</span> =<span class="st"> </span><span class="kw">c</span>(<span class="dv">100</span>,<span class="dv">160</span>) )</span>
<span id="cb263-6"><a href="fitting-a-model-to-data.html#cb263-6"></a></span>
<span id="cb263-7"><a href="fitting-a-model-to-data.html#cb263-7"></a><span class="co"># just to illustrate slices:</span></span>
<span id="cb263-8"><a href="fitting-a-model-to-data.html#cb263-8"></a></span>
<span id="cb263-9"><a href="fitting-a-model-to-data.html#cb263-9"></a>ldist.surv <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-10"><a href="fitting-a-model-to-data.html#cb263-10"></a><span class="st">  </span><span class="kw">mutate</span>(<span class="dt">length =</span> <span class="kw">substring</span>(length, <span class="dv">4</span>) <span class="op">%&gt;%</span><span class="st"> </span>as.numeric) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-11"><a href="fitting-a-model-to-data.html#cb263-11"></a><span class="st">  </span><span class="kw">filter</span>(year <span class="op">%in%</span><span class="st"> </span><span class="kw">c</span>(<span class="dv">2000</span>,<span class="dv">2005</span>,<span class="dv">2010</span>,<span class="dv">2015</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-12"><a href="fitting-a-model-to-data.html#cb263-12"></a><span class="st">  </span><span class="kw">group_by</span>(year,length) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-13"><a href="fitting-a-model-to-data.html#cb263-13"></a><span class="st">  </span><span class="kw">summarise</span>(<span class="dt">n =</span> <span class="kw">sum</span>(number)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-14"><a href="fitting-a-model-to-data.html#cb263-14"></a><span class="st">  </span><span class="kw">ggplot</span>(<span class="kw">aes</span>(<span class="dt">x =</span> length, <span class="dt">y =</span> n)) <span class="op">+</span><span class="st"> </span><span class="kw">geom_line</span>() <span class="op">+</span><span class="st"> </span></span>
<span id="cb263-15"><a href="fitting-a-model-to-data.html#cb263-15"></a><span class="st">  </span><span class="kw">geom_vline</span>(<span class="kw">aes</span>(<span class="dt">xintercept =</span> length), </span>
<span id="cb263-16"><a href="fitting-a-model-to-data.html#cb263-16"></a>             <span class="dt">lty =</span> <span class="dv">2</span>, <span class="dt">col =</span> <span class="st">&#39;orange&#39;</span>, </span>
<span id="cb263-17"><a href="fitting-a-model-to-data.html#cb263-17"></a>             <span class="dt">data =</span> slices <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-18"><a href="fitting-a-model-to-data.html#cb263-18"></a><span class="st">               </span><span class="kw">bind_rows</span>() <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-19"><a href="fitting-a-model-to-data.html#cb263-19"></a><span class="st">               </span><span class="kw">t</span>() <span class="op">%&gt;%</span><span class="st"> </span>.[<span class="op">-</span><span class="dv">1</span>,<span class="dv">1</span>] <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb263-20"><a href="fitting-a-model-to-data.html#cb263-20"></a><span class="st">               </span><span class="kw">tibble</span>(<span class="dt">length =</span> .)) <span class="op">+</span><span class="st"> </span></span>
<span id="cb263-21"><a href="fitting-a-model-to-data.html#cb263-21"></a><span class="st">  </span><span class="kw">facet_wrap</span>(<span class="op">~</span>year)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-4-1.png" width="672" /></p>
<div class="sourceCode" id="cb264"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb264-1"><a href="fitting-a-model-to-data.html#cb264-1"></a><span class="co"># set up aggregation info for length-based survey indices</span></span>
<span id="cb264-2"><a href="fitting-a-model-to-data.html#cb264-2"></a>SI1 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI1.csv&#39;</span>),</span>
<span id="cb264-3"><a href="fitting-a-model-to-data.html#cb264-3"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-4"><a href="fitting-a-model-to-data.html#cb264-4"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">1</span>]]))</span>
<span id="cb264-5"><a href="fitting-a-model-to-data.html#cb264-5"></a>SI2 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI2.csv&#39;</span>),</span>
<span id="cb264-6"><a href="fitting-a-model-to-data.html#cb264-6"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-7"><a href="fitting-a-model-to-data.html#cb264-7"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">2</span>]]))</span>
<span id="cb264-8"><a href="fitting-a-model-to-data.html#cb264-8"></a>SI3 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI3.csv&#39;</span>),</span>
<span id="cb264-9"><a href="fitting-a-model-to-data.html#cb264-9"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-10"><a href="fitting-a-model-to-data.html#cb264-10"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">3</span>]]))</span>
<span id="cb264-11"><a href="fitting-a-model-to-data.html#cb264-11"></a>SI4 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI4.csv&#39;</span>),</span>
<span id="cb264-12"><a href="fitting-a-model-to-data.html#cb264-12"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-13"><a href="fitting-a-model-to-data.html#cb264-13"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">4</span>]]))</span>
<span id="cb264-14"><a href="fitting-a-model-to-data.html#cb264-14"></a>SI5 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI5.csv&#39;</span>),</span>
<span id="cb264-15"><a href="fitting-a-model-to-data.html#cb264-15"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-16"><a href="fitting-a-model-to-data.html#cb264-16"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">5</span>]]))</span>
<span id="cb264-17"><a href="fitting-a-model-to-data.html#cb264-17"></a>SI6 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI6.csv&#39;</span>),</span>
<span id="cb264-18"><a href="fitting-a-model-to-data.html#cb264-18"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-19"><a href="fitting-a-model-to-data.html#cb264-19"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">6</span>]]))</span>
<span id="cb264-20"><a href="fitting-a-model-to-data.html#cb264-20"></a>SI7 &lt;-<span class="st"> </span><span class="kw">structure</span>(<span class="kw">read_csv</span>(<span class="st">&#39;data_provided/SI7.csv&#39;</span>),</span>
<span id="cb264-21"><a href="fitting-a-model-to-data.html#cb264-21"></a>                 <span class="dt">area =</span> <span class="kw">list</span>(area_file[[<span class="dv">1</span>]]<span class="op">$</span>areas) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">set_names</span>(.),</span>
<span id="cb264-22"><a href="fitting-a-model-to-data.html#cb264-22"></a>                 <span class="dt">length =</span> <span class="kw">create_intervals</span>(<span class="st">&#39;len&#39;</span>, slices[[<span class="dv">7</span>]]))</span></code></pre></div>
<div id="exercise-3" class="section level3">
<h3><span class="header-section-number">7.2.1</span> Exercise</h3>
<ul>
<li>Change the aggregation levels of the age-length distribution data so that data are compared to model results within the bins 3 - 6, 7, 8, 9, 10 - 11, and 12 - 15.</li>
</ul>
</div>
</div>
<div id="setting-up-likelihood-components" class="section level2">
<h2><span class="header-section-number">7.3</span> Setting up likelihood components</h2>
<p>Using Rgadget, writing the files that specify the likelihood componenets is straightforward.
When calling <code>gadgetlikelihood</code> and then writing it with <code>write.gadget.file</code>, a likelihood file
is created within R and written to disc. The likelihood file contains a list of likelihood
component specifications, and within each component is where the likelihood function, data, and
weighting of the likelihood component is specified.</p>
<p>Here we start with the distributional components. In all cases, each component receives a distinct
name (to be referenced later so keep them short and distinct), weights (1 to yield equal weights
for now), data as imported above, and the fleet names and stock names to which these data apply.
As a default, Rgadget specifies a sum of squares function to calculate the likelihood score
(<code>sumofsquares</code>), although a variety of other functions are possible, including one for stratified
sum of squares (<code>stratified</code>), multinomial function (<code>multinomial</code>), pearson function (<code>pearson</code>),
gamma function (<code>gamma</code>), log function (<code>log</code>), multivariate normal function (<code>mvn</code>) or a
multivariate logistic function (<code>mvlogistic</code>). Many of these functions have been tailored for
specific data situations (e.g., including tagging or predation data into a likelihood component).
More on these functions can be read in the <a href="https://hafro.github.io/gadget/docs/userguide">Gadget User Guide</a>. To change the default setting to
the stratified sum of squares, for example, one would include an additional argument <code>function = 'stratified',</code> to the <code>gadget_update</code> call.</p>
<div class="sourceCode" id="cb265"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb265-1"><a href="fitting-a-model-to-data.html#cb265-1"></a>lik &lt;-</span>
<span id="cb265-2"><a href="fitting-a-model-to-data.html#cb265-2"></a><span class="st">  </span><span class="kw">gadgetlikelihood</span>(<span class="st">&#39;likelihood&#39;</span>,gd,<span class="dt">missingOkay =</span> <span class="ot">TRUE</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-3"><a href="fitting-a-model-to-data.html#cb265-3"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-4"><a href="fitting-a-model-to-data.html#cb265-4"></a>                <span class="dt">name =</span> <span class="st">&quot;ldist.surv&quot;</span>,</span>
<span id="cb265-5"><a href="fitting-a-model-to-data.html#cb265-5"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-6"><a href="fitting-a-model-to-data.html#cb265-6"></a>                <span class="dt">data =</span> ldist.surv,</span>
<span id="cb265-7"><a href="fitting-a-model-to-data.html#cb265-7"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;surv&quot;</span>),</span>
<span id="cb265-8"><a href="fitting-a-model-to-data.html#cb265-8"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-9"><a href="fitting-a-model-to-data.html#cb265-9"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-10"><a href="fitting-a-model-to-data.html#cb265-10"></a>                <span class="dt">name =</span> <span class="st">&quot;aldist.surv&quot;</span>,</span>
<span id="cb265-11"><a href="fitting-a-model-to-data.html#cb265-11"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-12"><a href="fitting-a-model-to-data.html#cb265-12"></a>                <span class="dt">data =</span> aldist.surv, </span>
<span id="cb265-13"><a href="fitting-a-model-to-data.html#cb265-13"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;surv&quot;</span>),</span>
<span id="cb265-14"><a href="fitting-a-model-to-data.html#cb265-14"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-15"><a href="fitting-a-model-to-data.html#cb265-15"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-16"><a href="fitting-a-model-to-data.html#cb265-16"></a>                <span class="dt">name =</span> <span class="st">&quot;ldist.lln&quot;</span>,</span>
<span id="cb265-17"><a href="fitting-a-model-to-data.html#cb265-17"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-18"><a href="fitting-a-model-to-data.html#cb265-18"></a>                <span class="dt">data =</span> ldist.lln, </span>
<span id="cb265-19"><a href="fitting-a-model-to-data.html#cb265-19"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;lln&quot;</span>),</span>
<span id="cb265-20"><a href="fitting-a-model-to-data.html#cb265-20"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-21"><a href="fitting-a-model-to-data.html#cb265-21"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-22"><a href="fitting-a-model-to-data.html#cb265-22"></a>                <span class="dt">name =</span> <span class="st">&quot;aldist.lln&quot;</span>,</span>
<span id="cb265-23"><a href="fitting-a-model-to-data.html#cb265-23"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-24"><a href="fitting-a-model-to-data.html#cb265-24"></a>                <span class="dt">data =</span> aldist.lln,</span>
<span id="cb265-25"><a href="fitting-a-model-to-data.html#cb265-25"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;lln&quot;</span>),</span>
<span id="cb265-26"><a href="fitting-a-model-to-data.html#cb265-26"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-27"><a href="fitting-a-model-to-data.html#cb265-27"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-28"><a href="fitting-a-model-to-data.html#cb265-28"></a>                <span class="dt">name =</span> <span class="st">&quot;ldist.gil&quot;</span>,</span>
<span id="cb265-29"><a href="fitting-a-model-to-data.html#cb265-29"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-30"><a href="fitting-a-model-to-data.html#cb265-30"></a>                <span class="dt">data =</span> ldist.gil,</span>
<span id="cb265-31"><a href="fitting-a-model-to-data.html#cb265-31"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;gil&quot;</span>),</span>
<span id="cb265-32"><a href="fitting-a-model-to-data.html#cb265-32"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-33"><a href="fitting-a-model-to-data.html#cb265-33"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-34"><a href="fitting-a-model-to-data.html#cb265-34"></a>                <span class="dt">name =</span> <span class="st">&quot;aldist.gil&quot;</span>,</span>
<span id="cb265-35"><a href="fitting-a-model-to-data.html#cb265-35"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-36"><a href="fitting-a-model-to-data.html#cb265-36"></a>                <span class="dt">data =</span> aldist.gil,</span>
<span id="cb265-37"><a href="fitting-a-model-to-data.html#cb265-37"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;gil&quot;</span>),</span>
<span id="cb265-38"><a href="fitting-a-model-to-data.html#cb265-38"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-39"><a href="fitting-a-model-to-data.html#cb265-39"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-40"><a href="fitting-a-model-to-data.html#cb265-40"></a>                <span class="dt">name =</span> <span class="st">&quot;ldist.bmt&quot;</span>,</span>
<span id="cb265-41"><a href="fitting-a-model-to-data.html#cb265-41"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-42"><a href="fitting-a-model-to-data.html#cb265-42"></a>                <span class="dt">data =</span> ldist.bmt,</span>
<span id="cb265-43"><a href="fitting-a-model-to-data.html#cb265-43"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;bmt&quot;</span>),</span>
<span id="cb265-44"><a href="fitting-a-model-to-data.html#cb265-44"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-45"><a href="fitting-a-model-to-data.html#cb265-45"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;catchdistribution&quot;</span>,</span>
<span id="cb265-46"><a href="fitting-a-model-to-data.html#cb265-46"></a>                <span class="dt">name =</span> <span class="st">&quot;aldist.bmt&quot;</span>,</span>
<span id="cb265-47"><a href="fitting-a-model-to-data.html#cb265-47"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-48"><a href="fitting-a-model-to-data.html#cb265-48"></a>                <span class="dt">data =</span> aldist.bmt,</span>
<span id="cb265-49"><a href="fitting-a-model-to-data.html#cb265-49"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;bmt&quot;</span>),</span>
<span id="cb265-50"><a href="fitting-a-model-to-data.html#cb265-50"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb265-51"><a href="fitting-a-model-to-data.html#cb265-51"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;stockdistribution&quot;</span>,</span>
<span id="cb265-52"><a href="fitting-a-model-to-data.html#cb265-52"></a>                <span class="dt">name =</span> <span class="st">&quot;matp.surv&quot;</span>,</span>
<span id="cb265-53"><a href="fitting-a-model-to-data.html#cb265-53"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb265-54"><a href="fitting-a-model-to-data.html#cb265-54"></a>                <span class="dt">data =</span> matp.surv,</span>
<span id="cb265-55"><a href="fitting-a-model-to-data.html#cb265-55"></a>                <span class="dt">fleetnames =</span> <span class="kw">c</span>(<span class="st">&quot;surv&quot;</span>),</span>
<span id="cb265-56"><a href="fitting-a-model-to-data.html#cb265-56"></a>                <span class="dt">stocknames =</span><span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) </span>
<span id="cb265-57"><a href="fitting-a-model-to-data.html#cb265-57"></a></span>
<span id="cb265-58"><a href="fitting-a-model-to-data.html#cb265-58"></a>lik</span></code></pre></div>
<pre><code>## ; Generated by Rgadget 0.5
## ; 
## [component]
## name ldist.surv
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.ldist.surv.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.ldist.surv.area.agg
## ageaggfile   Aggfiles/catchdistribution.ldist.surv.age.agg
## lenaggfile   Aggfiles/catchdistribution.ldist.surv.len.agg
## fleetnames   surv
## stocknames   lingimm lingmat
## ; 
## [component]
## name aldist.surv
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.aldist.surv.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.aldist.surv.area.agg
## ageaggfile   Aggfiles/catchdistribution.aldist.surv.age.agg
## lenaggfile   Aggfiles/catchdistribution.aldist.surv.len.agg
## fleetnames   surv
## stocknames   lingimm lingmat
## ; 
## [component]
## name ldist.lln
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.ldist.lln.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.ldist.lln.area.agg
## ageaggfile   Aggfiles/catchdistribution.ldist.lln.age.agg
## lenaggfile   Aggfiles/catchdistribution.ldist.lln.len.agg
## fleetnames   lln
## stocknames   lingimm lingmat
## ; 
## [component]
## name aldist.lln
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.aldist.lln.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.aldist.lln.area.agg
## ageaggfile   Aggfiles/catchdistribution.aldist.lln.age.agg
## lenaggfile   Aggfiles/catchdistribution.aldist.lln.len.agg
## fleetnames   lln
## stocknames   lingimm lingmat
## ; 
## [component]
## name ldist.gil
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.ldist.gil.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.ldist.gil.area.agg
## ageaggfile   Aggfiles/catchdistribution.ldist.gil.age.agg
## lenaggfile   Aggfiles/catchdistribution.ldist.gil.len.agg
## fleetnames   gil
## stocknames   lingimm lingmat
## ; 
## [component]
## name aldist.gil
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.aldist.gil.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.aldist.gil.area.agg
## ageaggfile   Aggfiles/catchdistribution.aldist.gil.age.agg
## lenaggfile   Aggfiles/catchdistribution.aldist.gil.len.agg
## fleetnames   gil
## stocknames   lingimm lingmat
## ; 
## [component]
## name ldist.bmt
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.ldist.bmt.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.ldist.bmt.area.agg
## ageaggfile   Aggfiles/catchdistribution.ldist.bmt.age.agg
## lenaggfile   Aggfiles/catchdistribution.ldist.bmt.len.agg
## fleetnames   bmt
## stocknames   lingimm lingmat
## ; 
## [component]
## name aldist.bmt
## weight   1
## type catchdistribution
## datafile Data/catchdistribution.aldist.bmt.sumofsquares
## function sumofsquares
## aggregationlevel 0
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/catchdistribution.aldist.bmt.area.agg
## ageaggfile   Aggfiles/catchdistribution.aldist.bmt.age.agg
## lenaggfile   Aggfiles/catchdistribution.aldist.bmt.len.agg
## fleetnames   bmt
## stocknames   lingimm lingmat
## ; 
## [component]
## name matp.surv
## weight   1
## type stockdistribution
## datafile Data/stockdistribution.matp.surv.sumofsquares
## function sumofsquares
## overconsumption  0
## epsilon  10
## areaaggfile  Aggfiles/stockdistribution.matp.surv.area.agg
## ageaggfile   Aggfiles/stockdistribution.matp.surv.age.agg
## lenaggfile   Aggfiles/stockdistribution.matp.surv.len.agg
## fleetnames   surv
## stocknames   lingimm lingmat</code></pre>
<p>Note here that Rgadget automatically creates references to necessary data files (‘Data/…’) and
aggregation files (‘Agg/…’) that define the bin structure as defined by data attributes
(see previous section). When <code>write.gadget.file</code> is finally called after we are done adding
all likelihood components, these data and agg files will be written alongside this likelihood
file, and a reference to this likelihood file will also be drawn within the ‘main’ file.</p>
<p>You can also see how individual aggregation files will be printed by e.g.:</p>
<div class="sourceCode" id="cb267"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb267-1"><a href="fitting-a-model-to-data.html#cb267-1"></a>lik[[<span class="dv">2</span>]]<span class="op">$</span>ageaggfile</span></code></pre></div>
<pre><code>## ; Generated by Rgadget 0.5
## age3 3
## age4 4
## age5 5
## age6 6
## age7 7
## age8 8
## age9 9
## age10    10
## age11    11  12  13  14  15</code></pre>
<p>which gives you the age aggregation for the second likelihood component.</p>
<div id="setting-up-survey-indices" class="section level3">
<h3><span class="header-section-number">7.3.1</span> Setting up survey indices</h3>
<p>Incorporating survey index components is very similar except that 1) the fact that the survey
index is length-based is determined by the length attribute of the data frame, which sets the
argument <code>si_type</code> to a value of <code>lengths</code>, and 2) a catchability function is also specified
under the argument <code>'fittype'</code>. In addition, the argument <code>biomass</code> has a default setting of 0,
signifying a numbers-based index (rather than a biomass-based index, which has a value of 1).
Other options for <code>si_type</code> can be read about in the <a href="https://hafro.github.io/gadget/docs/userguide">Gadget User Guide</a>, and <code>ages</code>, <code>fleets</code>, <code>acoustic</code>, and <code>effort</code>.</p>
<p>The catchability function defines the type of linear regression to be used to calculate
the likelihood score. Options include a linear fit on the orignal or log scale (<code>linearfit</code>
or <code>loglinearfit</code>), linear fit with a fixed slope on the original or log scale (<code>fixedslopelinearfit</code>
or <code>fixedslopeloglinearfit</code>), linear fit with a fixed intercept on the original or log scale
(<code>fixedinterceptlinearfit</code> or <code>fixedinterceptlinearfit</code>), or a linear/loglinear function with
both the slope and intercept fixed (<code>fixedlinearfit</code> or <code>fixedloglinearfit</code>). In the first set
of cases (linear or loglinear fits), two parameters would be estimated; in the next two sets of
cases, only a single parameter is estimated (slope or intercept, whichever is not fixed). In
the last set of cases (fixed liner or loglinear fits), no parameters are estimated. Whenever a
parameter is fixed, its value needs to be included as an additional argument to <code>gadget_update</code>.
For example, catchability of the indices of smaller sized fish below are estimated using a
log linear fit with both slopes and intercepts estimated, but catchabilities for indices of
larger sized fish are calculated using log linear fits with fixed slopes. The slopes are
fixed to a value of 1, so the argument <code>slope = 1</code> is included in the <code>gadget_update</code> call.</p>
<p>Notice that, unlike the distributional likelihood components, a fleet is not specified
for the survey indices, unless <code>si_type</code> is set to <code>fleets</code>, <code>effort</code>, <code>acoustic</code> (rather than <code>length</code> as in our example).
When indices are not length- or age-based, a single catchability is estimated, rather
than the series of catchabilities estimated for each age or length index series.
Each survey index is
matched to stock size observations at a given time and area; therefore, if there are two
length- or age-based survey index series with the same time and area, they can each be
incorporated as separate likelihood components as long as they have different names.</p>
<div class="sourceCode" id="cb269"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb269-1"><a href="fitting-a-model-to-data.html#cb269-1"></a>lik &lt;-</span>
<span id="cb269-2"><a href="fitting-a-model-to-data.html#cb269-2"></a><span class="st">  </span>lik <span class="op">%&gt;%</span><span class="st">  </span></span>
<span id="cb269-3"><a href="fitting-a-model-to-data.html#cb269-3"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-4"><a href="fitting-a-model-to-data.html#cb269-4"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">1</span>]),</span>
<span id="cb269-5"><a href="fitting-a-model-to-data.html#cb269-5"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-6"><a href="fitting-a-model-to-data.html#cb269-6"></a>                <span class="dt">data =</span> SI1,</span>
<span id="cb269-7"><a href="fitting-a-model-to-data.html#cb269-7"></a>                <span class="dt">fittype =</span> <span class="st">&#39;loglinearfit&#39;</span>,</span>
<span id="cb269-8"><a href="fitting-a-model-to-data.html#cb269-8"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb269-9"><a href="fitting-a-model-to-data.html#cb269-9"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-10"><a href="fitting-a-model-to-data.html#cb269-10"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">2</span>]),</span>
<span id="cb269-11"><a href="fitting-a-model-to-data.html#cb269-11"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-12"><a href="fitting-a-model-to-data.html#cb269-12"></a>                <span class="dt">data =</span> SI2,</span>
<span id="cb269-13"><a href="fitting-a-model-to-data.html#cb269-13"></a>                <span class="dt">fittype =</span> <span class="st">&#39;loglinearfit&#39;</span>,</span>
<span id="cb269-14"><a href="fitting-a-model-to-data.html#cb269-14"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb269-15"><a href="fitting-a-model-to-data.html#cb269-15"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-16"><a href="fitting-a-model-to-data.html#cb269-16"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">3</span>]),</span>
<span id="cb269-17"><a href="fitting-a-model-to-data.html#cb269-17"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-18"><a href="fitting-a-model-to-data.html#cb269-18"></a>                <span class="dt">data =</span> SI3,</span>
<span id="cb269-19"><a href="fitting-a-model-to-data.html#cb269-19"></a>                <span class="dt">fittype =</span> <span class="st">&#39;fixedslopeloglinearfit&#39;</span>,</span>
<span id="cb269-20"><a href="fitting-a-model-to-data.html#cb269-20"></a>                <span class="dt">slope=</span><span class="dv">1</span>,</span>
<span id="cb269-21"><a href="fitting-a-model-to-data.html#cb269-21"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb269-22"><a href="fitting-a-model-to-data.html#cb269-22"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-23"><a href="fitting-a-model-to-data.html#cb269-23"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">4</span>]),</span>
<span id="cb269-24"><a href="fitting-a-model-to-data.html#cb269-24"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-25"><a href="fitting-a-model-to-data.html#cb269-25"></a>                <span class="dt">data =</span> SI4,</span>
<span id="cb269-26"><a href="fitting-a-model-to-data.html#cb269-26"></a>                <span class="dt">fittype =</span> <span class="st">&#39;fixedslopeloglinearfit&#39;</span>,</span>
<span id="cb269-27"><a href="fitting-a-model-to-data.html#cb269-27"></a>                <span class="dt">slope=</span><span class="dv">1</span>,</span>
<span id="cb269-28"><a href="fitting-a-model-to-data.html#cb269-28"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb269-29"><a href="fitting-a-model-to-data.html#cb269-29"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-30"><a href="fitting-a-model-to-data.html#cb269-30"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">5</span>]),</span>
<span id="cb269-31"><a href="fitting-a-model-to-data.html#cb269-31"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-32"><a href="fitting-a-model-to-data.html#cb269-32"></a>                <span class="dt">data =</span> SI5,</span>
<span id="cb269-33"><a href="fitting-a-model-to-data.html#cb269-33"></a>                <span class="dt">fittype =</span> <span class="st">&#39;fixedslopeloglinearfit&#39;</span>,</span>
<span id="cb269-34"><a href="fitting-a-model-to-data.html#cb269-34"></a>                <span class="dt">slope=</span><span class="dv">1</span>,</span>
<span id="cb269-35"><a href="fitting-a-model-to-data.html#cb269-35"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb269-36"><a href="fitting-a-model-to-data.html#cb269-36"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-37"><a href="fitting-a-model-to-data.html#cb269-37"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">6</span>]),</span>
<span id="cb269-38"><a href="fitting-a-model-to-data.html#cb269-38"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-39"><a href="fitting-a-model-to-data.html#cb269-39"></a>                <span class="dt">data =</span> SI6,</span>
<span id="cb269-40"><a href="fitting-a-model-to-data.html#cb269-40"></a>                <span class="dt">fittype =</span> <span class="st">&#39;fixedslopeloglinearfit&#39;</span>,</span>
<span id="cb269-41"><a href="fitting-a-model-to-data.html#cb269-41"></a>                <span class="dt">slope=</span><span class="dv">1</span>,</span>
<span id="cb269-42"><a href="fitting-a-model-to-data.html#cb269-42"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb269-43"><a href="fitting-a-model-to-data.html#cb269-43"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;surveyindices&quot;</span>,</span>
<span id="cb269-44"><a href="fitting-a-model-to-data.html#cb269-44"></a>                <span class="dt">name =</span> <span class="kw">paste0</span>(<span class="st">&quot;si.&quot;</span>, <span class="kw">names</span>(slices)[<span class="dv">7</span>]),</span>
<span id="cb269-45"><a href="fitting-a-model-to-data.html#cb269-45"></a>                <span class="dt">weight =</span> <span class="dv">1</span>,</span>
<span id="cb269-46"><a href="fitting-a-model-to-data.html#cb269-46"></a>                <span class="dt">data =</span> SI7,</span>
<span id="cb269-47"><a href="fitting-a-model-to-data.html#cb269-47"></a>                <span class="dt">fittype =</span> <span class="st">&#39;fixedslopeloglinearfit&#39;</span>,</span>
<span id="cb269-48"><a href="fitting-a-model-to-data.html#cb269-48"></a>                <span class="dt">slope=</span><span class="dv">1</span>,</span>
<span id="cb269-49"><a href="fitting-a-model-to-data.html#cb269-49"></a>                <span class="dt">stocknames =</span> <span class="kw">c</span>(<span class="st">&quot;lingimm&quot;</span>,<span class="st">&quot;lingmat&quot;</span>)) </span>
<span id="cb269-50"><a href="fitting-a-model-to-data.html#cb269-50"></a>lik </span></code></pre></div>
<p>Finally, there are two components to the likelihood that do not incorporate data but
are instead used to ensure that the optimisation search algorithm remains within
reasonable ranges of the defined model. The first component provides penalties to for
exceeding parameter bounds as set by the user in the input parameter file.
In this example, the weight is set to 0.5,
but see the troubleshooting page for cases in which it may be wise to set this weight
higher. The data frame provided to this likelihood component specifies the power and
parameter weights supplied if the parameter value exceeds its upper and lower bounds.
If the likelihood of a parameter exceeds either the upper or lower bound,
the distance between the bound and the parameter value is squared and multiplied by the
parameter weights 10 000; then the sum of these scores across all parameters is
multiplied by the 0.5 weighting before being summed along with the other
likelihood components to form the total.</p>
</div>
<div id="penalty-functions" class="section level3">
<h3><span class="header-section-number">7.3.2</span> Penalty functions</h3>
<p>Understocking introduces a penalty when there are insufficent prey to met the requirements
of the predators. For example, if landings of the fleets exceeds available biomass,
then the penalty is applied. The understocking penalty likelihood is then defined as
the sum of the number of prey that are ‘missing’, raised to a power set by default
to 2, and multiplied by the likelihood weight of 100 as indicated below.</p>
<div class="sourceCode" id="cb270"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb270-1"><a href="fitting-a-model-to-data.html#cb270-1"></a>lik &lt;-</span>
<span id="cb270-2"><a href="fitting-a-model-to-data.html#cb270-2"></a><span class="st">  </span>lik <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb270-3"><a href="fitting-a-model-to-data.html#cb270-3"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;penalty&quot;</span>,</span>
<span id="cb270-4"><a href="fitting-a-model-to-data.html#cb270-4"></a>                <span class="dt">name =</span> <span class="st">&quot;bounds&quot;</span>,</span>
<span id="cb270-5"><a href="fitting-a-model-to-data.html#cb270-5"></a>                <span class="dt">weight =</span> <span class="st">&quot;0.5&quot;</span>,</span>
<span id="cb270-6"><a href="fitting-a-model-to-data.html#cb270-6"></a>                <span class="dt">data =</span> <span class="kw">data.frame</span>(</span>
<span id="cb270-7"><a href="fitting-a-model-to-data.html#cb270-7"></a>                  <span class="dt">switch =</span> <span class="kw">c</span>(<span class="st">&quot;default&quot;</span>),</span>
<span id="cb270-8"><a href="fitting-a-model-to-data.html#cb270-8"></a>                  <span class="dt">power =</span> <span class="kw">c</span>(<span class="dv">2</span>),</span>
<span id="cb270-9"><a href="fitting-a-model-to-data.html#cb270-9"></a>                  <span class="dt">upperW=</span><span class="dv">10000</span>,</span>
<span id="cb270-10"><a href="fitting-a-model-to-data.html#cb270-10"></a>                  <span class="dt">lowerW=</span><span class="dv">10000</span>,</span>
<span id="cb270-11"><a href="fitting-a-model-to-data.html#cb270-11"></a>                  <span class="dt">stringsAsFactors =</span> <span class="ot">FALSE</span>)) <span class="op">%&gt;%</span></span>
<span id="cb270-12"><a href="fitting-a-model-to-data.html#cb270-12"></a><span class="st">  </span><span class="kw">gadget_update</span>(<span class="st">&quot;understocking&quot;</span>,</span>
<span id="cb270-13"><a href="fitting-a-model-to-data.html#cb270-13"></a>                <span class="dt">name =</span> <span class="st">&quot;understocking&quot;</span>,</span>
<span id="cb270-14"><a href="fitting-a-model-to-data.html#cb270-14"></a>                <span class="dt">weight =</span> <span class="st">&quot;100&quot;</span>)</span>
<span id="cb270-15"><a href="fitting-a-model-to-data.html#cb270-15"></a></span>
<span id="cb270-16"><a href="fitting-a-model-to-data.html#cb270-16"></a>lik <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb270-17"><a href="fitting-a-model-to-data.html#cb270-17"></a><span class="st">  </span><span class="kw">write.gadget.file</span>(gd)</span></code></pre></div>
<p>Notice that when the likelihood file is written, so are all the supporting
aggregation files under the ‘Aggfiles’ folder.</p>
</div>
</div>
<div id="fitting-a-gadget-model-to-data" class="section level2">
<h2><span class="header-section-number">7.4</span> Fitting a Gadget model to data</h2>
<p>Now that all data and likelihood components are incorporated, it is possible to run <code>gadget_optimise</code> to run a fitting procedure. Like any other optimisation routine, what is still needed are 1) starting values for the parameters, and 2) optimisation routine settings.</p>
<div id="create-starting-values" class="section level3">
<h3><span class="header-section-number">7.4.1</span> Create starting values</h3>
<p>If we start here with the same simple <code>gadget_evaluate</code> simulation as in day 2 of the
ling model, we can see that a file called ‘params.out’ is automatically generated
(same timestamp as the simple_log). However, if you open this file, is shows that
each parameter was given a value of 1 with bounds set to {-9999, 9999} and no
optimisation (0). Therefore, this simulation was run with very unrealistic parameters.
Obviously this is not a helpful run in itself, but it is at least useful for
conveniently generating an initial parameter file with the correct Gadget
structure containing all the parameters specified throughout the Gadget model files.</p>
<div class="sourceCode" id="cb271"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb271-1"><a href="fitting-a-model-to-data.html#cb271-1"></a><span class="kw">gadget_evaluate</span>(gd,<span class="dt">log =</span> <span class="st">&#39;ling_log&#39;</span>)</span></code></pre></div>
<pre><code>## [1] &quot;/home/runner/work/gadget-course/gadget-course/ling_model/01-base&quot;</code></pre>
<div class="sourceCode" id="cb273"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb273-1"><a href="fitting-a-model-to-data.html#cb273-1"></a><span class="kw">read.gadget.parameters</span>(<span class="kw">paste0</span>(gd,<span class="st">&#39;/params.out&#39;</span>))</span></code></pre></div>
<pre><code>## [90m# A tibble: 81 x 5[39m
##    switch              value lower upper optimise
##  [90m*[39m [3m[90m&lt;chr&gt;[39m[23m               [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m    [3m[90m&lt;dbl&gt;[39m[23m
## [90m 1[39m ling.Linf               1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 2[39m ling.k                  1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 3[39m ling.walpha             1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 4[39m ling.wbeta              1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 5[39m ling.bbin               1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 6[39m lingimm.M               1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 7[39m lingimm.init.scalar     1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 8[39m ling.init.F             1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m 9[39m lingimm.init.3          1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m10[39m lingimm.init.4          1 -[31m[4m9[24m99[39m[31m9[39m  [4m9[24m999        0
## [90m# … with 71 more rows[39m</code></pre>
<p>Now that the structure is set, it is much easier to change the bounds and starting
values to more realistic ones using <code>init_guess</code>. This function uses the <code>grepl</code>
function internally to match names, so that large chunks of parameters with similar
names can have their bounds similarly changed.</p>
<div class="sourceCode" id="cb275"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb275-1"><a href="fitting-a-model-to-data.html#cb275-1"></a>lw_pars &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="fl">0.00000228</span>, <span class="fl">3.20</span>) <span class="co">#same values as in day 2</span></span>
<span id="cb275-2"><a href="fitting-a-model-to-data.html#cb275-2"></a></span>
<span id="cb275-3"><a href="fitting-a-model-to-data.html#cb275-3"></a><span class="co">## update the input parameters with sane initial guesses</span></span>
<span id="cb275-4"><a href="fitting-a-model-to-data.html#cb275-4"></a><span class="kw">read.gadget.parameters</span>(<span class="kw">sprintf</span>(<span class="st">&#39;%s/params.out&#39;</span>,gd)) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-5"><a href="fitting-a-model-to-data.html#cb275-5"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;rec.[0-9]|init.[0-9]&#39;</span>,<span class="dv">1</span>,<span class="fl">0.001</span>,<span class="dv">1000</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span></span>
<span id="cb275-6"><a href="fitting-a-model-to-data.html#cb275-6"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;recl&#39;</span>,<span class="dv">12</span>,<span class="dv">4</span>,<span class="dv">20</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-7"><a href="fitting-a-model-to-data.html#cb275-7"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;rec.sd&#39;</span>,<span class="dv">5</span>, <span class="dv">4</span>, <span class="dv">20</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-8"><a href="fitting-a-model-to-data.html#cb275-8"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;Linf&#39;</span>,<span class="dv">160</span>, <span class="dv">100</span>, <span class="dv">200</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-9"><a href="fitting-a-model-to-data.html#cb275-9"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;k$&#39;</span>,<span class="dv">90</span>, <span class="dv">40</span>, <span class="dv">100</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-10"><a href="fitting-a-model-to-data.html#cb275-10"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;bbin&#39;</span>,<span class="dv">6</span>, <span class="fl">1e-08</span>, <span class="dv">100</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-11"><a href="fitting-a-model-to-data.html#cb275-11"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;alpha&#39;</span>, <span class="fl">0.5</span>,  <span class="fl">0.01</span>, <span class="dv">3</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-12"><a href="fitting-a-model-to-data.html#cb275-12"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;l50&#39;</span>,<span class="dv">50</span>,<span class="dv">10</span>,<span class="dv">100</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-13"><a href="fitting-a-model-to-data.html#cb275-13"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;walpha&#39;</span>,lw_pars[<span class="dv">1</span>], <span class="fl">1e-10</span>, <span class="dv">1</span>,<span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-14"><a href="fitting-a-model-to-data.html#cb275-14"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;wbeta&#39;</span>,lw_pars[<span class="dv">2</span>], <span class="dv">2</span>, <span class="dv">4</span>,<span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-15"><a href="fitting-a-model-to-data.html#cb275-15"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;M$&#39;</span>,<span class="fl">0.15</span>,<span class="fl">0.001</span>,<span class="dv">1</span>,<span class="dv">0</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-16"><a href="fitting-a-model-to-data.html#cb275-16"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;rec.scalar&#39;</span>,<span class="dv">400</span>,<span class="dv">1</span>,<span class="dv">500</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-17"><a href="fitting-a-model-to-data.html#cb275-17"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;init.scalar&#39;</span>,<span class="dv">200</span>,<span class="dv">1</span>,<span class="dv">300</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-18"><a href="fitting-a-model-to-data.html#cb275-18"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;mat2&#39;</span>,<span class="dv">60</span>,<span class="fl">0.75</span><span class="op">*</span><span class="dv">60</span>,<span class="fl">1.25</span><span class="op">*</span><span class="dv">60</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-19"><a href="fitting-a-model-to-data.html#cb275-19"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;mat1&#39;</span>,<span class="dv">70</span>,  <span class="dv">10</span>, <span class="dv">200</span>, <span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-20"><a href="fitting-a-model-to-data.html#cb275-20"></a><span class="st">  </span><span class="kw">init_guess</span>(<span class="st">&#39;init.F&#39;</span>,<span class="fl">0.4</span>,<span class="fl">0.1</span>,<span class="dv">1</span>,<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span></span>
<span id="cb275-21"><a href="fitting-a-model-to-data.html#cb275-21"></a><span class="st">  </span><span class="kw">write.gadget.parameters</span>(.,<span class="dt">file=</span><span class="kw">sprintf</span>(<span class="st">&#39;%s/params.in&#39;</span>,gd))</span>
<span id="cb275-22"><a href="fitting-a-model-to-data.html#cb275-22"></a></span>
<span id="cb275-23"><a href="fitting-a-model-to-data.html#cb275-23"></a><span class="kw">read.gadget.parameters</span>(<span class="kw">sprintf</span>(<span class="st">&#39;%s/params.in&#39;</span>,gd))</span></code></pre></div>
<pre><code>## [90m# A tibble: 81 x 5[39m
##    switch                     value    lower upper optimise
##  [90m*[39m [3m[90m&lt;chr&gt;[39m[23m                      [3m[90m&lt;dbl&gt;[39m[23m    [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m    [3m[90m&lt;dbl&gt;[39m[23m
## [90m 1[39m ling.Linf           160          1.00[90me[39m+ 2   200        1
## [90m 2[39m ling.k               90          4.00[90me[39m+ 1   100        1
## [90m 3[39m ling.walpha           0.000[4m0[24m[4m0[24m[4m2[24m28 1.00[90me[39m[31m-10[39m     1        0
## [90m 4[39m ling.wbeta            3.2        2.00[90me[39m+ 0     4        0
## [90m 5[39m ling.bbin             6          1.00[90me[39m[31m- 8[39m   100        1
## [90m 6[39m lingimm.M             0.15       1.00[90me[39m[31m- 3[39m     1        0
## [90m 7[39m lingimm.init.scalar 200          1.00[90me[39m+ 0   300        1
## [90m 8[39m ling.init.F           0.4        1.00[90me[39m[31m- 1[39m     1        1
## [90m 9[39m lingimm.init.3        1          1.00[90me[39m[31m- 3[39m  [4m1[24m000        1
## [90m10[39m lingimm.init.4        1          1.00[90me[39m[31m- 3[39m  [4m1[24m000        1
## [90m# … with 71 more rows[39m</code></pre>
<p>Now is a good point to scan the resulting ‘params.in’ file to make sure that
a parameter was not forgotten and left with default values and bounds.</p>
<div id="exercise-4" class="section level4">
<h4><span class="header-section-number">7.4.1.1</span> Exercise</h4>
<ul>
<li><p>Suppose that age sampling was done so that the same sampling effort was spread across all
ages equally (roughly 30 fish per length range to attain roughly 30 age samples per age).
Change the likelihood component function for age-length data to the appropriate function.</p></li>
<li><p>Change the survey indices to be biomass indices using <code>gadget_update</code>.</p></li>
<li><p>Use <code>init_guess</code> to change the bounds of only one set of selectivity parameters.</p></li>
</ul>
</div>
</div>
</div>
<div id="set-optimisation-routine" class="section level2">
<h2><span class="header-section-number">7.5</span> Set optimisation routine</h2>
<p>To run an optimisation via <code>gadget_optimize</code> is simple, the user provides an input parameter file with starting values
(below as <code>params.in = 'params.in'</code>), and providing a file name to which final parameter
values should be written (below as <code>params.out = 'params.init'</code>).</p>
<div class="sourceCode" id="cb277"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb277-1"><a href="fitting-a-model-to-data.html#cb277-1"></a><span class="kw">timestamp</span>()</span>
<span id="cb277-2"><a href="fitting-a-model-to-data.html#cb277-2"></a><span class="kw">gadget_optimize</span>(gd,<span class="dt">params.in =</span> <span class="st">&#39;params.in&#39;</span>, <span class="dt">params.out =</span> <span class="st">&#39;params.init&#39;</span>)</span>
<span id="cb277-3"><a href="fitting-a-model-to-data.html#cb277-3"></a><span class="kw">timestamp</span>()</span></code></pre></div>
<p>Now that reasonable bounds and starting values have been set for an
optimisation run, default settings can be used to run a short and simple
Gadget optimisation. If you open the <code>params.init</code> file, comments can be found
at the top that detail the computer and timing of the run (as in a simulation run),
as well as optimisation information (something like ‘Hooke &amp; Jeeves algorithm ran
for 1039 function evaluations’), the likelihood value at the end ‘1e+10’ and a
reason for stopping (‘because the maximum number of function evaluations was reached’).
You can also see from the timestamps above that this run took roughly 30 seconds,
depending on the computer being used.</p>
<p>Obviously, the default settings for optimisation (1000 function evaluations
using the Hooke and Jeeves algorithm), are insufficient to find a reasonable
optimum. Gadget can also take quite a while to optimise a model (~ 6 hours for
ling on a very fast computer). Therefore, it is best to plan ahead of time on
which computer and when a model will be optimised, as well as which optimisation
methods will be used.</p>
<p>To change from the default settings, an opimisation file needs to be provided
to <code>gadget_optimize</code> via the <code>control</code> argument. This is the file we provide for
demonstration: it shows that we have implemented 3 consecutive optimisation
routines. The first begins with simulated annealing (and parameter settings
needed for it as well as a seed), followed by a Hooke and Jeeves algorithm
that begins where simulated annealing leaves off, and finally a BFGS algorithm.
The three routines are listed in this manner to consecutively to transition from
a broader global search (simulated annealing) to one that provides faster
(Hooke and Jeeves) and more precise (BFGS) results, in an attempt to make the
search more efficient. These three are the only algorithms currently implemented,
but others are in a development phase. Also note that a seed is set in the
beginning algorithm: it is good practice to both use random starting values
as well as a set seed to check for possible optimisation problems. More
information on parameters specific to each algorithm can be found in the <a href="https://hafro.github.io/gadget/docs/userguide">Gadget User Guide</a>.</p>
<p>Each algorithm also has a low maximum number of iterations set in the
optimisation file below, which is clearly not enough to be realistic: realistic
values used for ling are given as notes within the optinfofile and are not read
below. However, the each model presents new challenges to the search algorithm,
so in some complex cases it may be necessary to rely mostly on simulating annealing,
whereas in other more well-defined cases it may be possible to rely mostly on the
faster algorithms. At this point in development, speeding Gadget runs is mostly
done by using computers with multiple cores and faster processors.</p>
<div class="sourceCode" id="cb278"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb278-1"><a href="fitting-a-model-to-data.html#cb278-1"></a>optinfo &lt;-<span class="st"> </span><span class="kw">read.gadget.file</span>(<span class="st">&#39;data_provided&#39;</span>, <span class="st">&#39;optinfofile&#39;</span>)</span>
<span id="cb278-2"><a href="fitting-a-model-to-data.html#cb278-2"></a>optinfo</span></code></pre></div>
<pre><code>## ; Generated by Rgadget 0.5
## [simann]
## simanniter   200     ; number of simulated annealing iterations, normally set to 1000000 for ling
## simanneps    0.001       ; minimum epsilon, simann halt criteria
## t    30000000        ; simulated annealing initial temperature
## rt   0.85        ; temperature reduction factor
## nt   2       ; number of loops before temperature adjusted
## ns   5       ; number of loops before step length adjusted
## vm   1       ; initial value for the maximum step length
## cstep    2       ; step length adjustment factor
## lratio   0.3     ; lower limit for ratio when adjusting step length
## uratio   0.7     ; upper limit for ratio when adjusting step length
## check    4       ; number of temperature loops to check
## seed 5908
## [hooke]
## hookeiter    100     ; number of hooke &amp; jeeves iterations, normally set to 40000 for ling
## hookeeps 1e-04       ; minimum epsilon, hooke &amp; jeeves halt criteria
## rho  0.5     ; value for the resizing multiplier
## lambda   0       ; initial value for the step length
## [bfgs]
## bfgsiter 100     ; number of bfgs iterations, normally set to 10000 for ling
## bfgseps  0.01        ; minimum epsilon, bfgs halt criteria
## sigma    0.01        ; armijo convergence criteria
## beta 0.3     ; armijo adjustment factor
##  </code></pre>
<p>Here, we have implemented a fitting procedure that begins where the
last default optimisation values left off (in the ‘params.init’ file).
The ‘params.opt’ file will therefore be the result of a longer and more
well-defined search as described by the ‘optinfofile’.</p>
<div class="sourceCode" id="cb280"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb280-1"><a href="fitting-a-model-to-data.html#cb280-1"></a><span class="kw">timestamp</span>()</span>
<span id="cb280-2"><a href="fitting-a-model-to-data.html#cb280-2"></a><span class="kw">gadget_optimize</span>(gd,<span class="dt">params.in =</span> <span class="st">&#39;params.in&#39;</span>, <span class="dt">params.out =</span> <span class="st">&#39;params.init&#39;</span>, <span class="dt">control =</span> optinfo)</span>
<span id="cb280-3"><a href="fitting-a-model-to-data.html#cb280-3"></a><span class="kw">timestamp</span>()</span></code></pre></div>
<div id="exercise-5" class="section level4">
<h4><span class="header-section-number">7.5.0.1</span> Exercise</h4>
<ul>
<li>Try changing the parameter starting values to the params.forsim file within the ‘data_provided’ folder. Does the optimisation finish any quicker?</li>
</ul>
</div>
</div>
<div id="using-the-iterative-reweighting-function-to-fit-a-gadget-statistical-model" class="section level2">
<h2><span class="header-section-number">7.6</span> Using the iterative reweighting function to fit a Gadget statistical model</h2>
<p>The total objective function used the modeling process combines
equations  to  using the following formula:</p>
<p><span class="math display">\[\begin{equation}\label{eq:loglik}
l^{T} = \sum_g  w_{gf}^{SI}
l_{g,S}^{SI} + \sum_{f\in \{S,T,G,L\}} \left(
w_{f}^{LD}  l_{f}^{LD} + w_{f}^{AL}
l_{f}^{AL}\right) + w^{M}l^{M}
\end{equation}\]</span>
where <span class="math inline">\(f=S,T,G\)</span> or <span class="math inline">\(L\)</span> denotes the spring survey, trawl, gillnet and
longline fleets respectively and <span class="math inline">\(w\)</span>’s are the weights assigned to each likelihood components.</p>
<p>The weights, <span class="math inline">\(w_i\)</span>, are necessary for several reasons. First of all it
is used to to prevent some components from dominating the likelihood
function. When one data source dominates, the model fits that one exactly
and ignores information from the other data sources. Another would be to
reduce the effect of low quality
data. It can be used as an a priori estimates of the variance in each
subset of the data.</p>
<p>Assigning likelihood weights is not a trivial matter; it has in the past
been the most time-consuming part of developing a Gadget model. Historicall this was
been done using some form of ‘expert judgement’. General heuristics
have recently been developed to estimated these weights
objectively. Here the iterative re–weighting heuristic introduced by
<span class="citation">@stefansson2003issues</span>, and subsequently implemented in
<span class="citation">@taylor2007simple</span>, is used. Rgadget implements this heuristing using the <code>gadget.iterative</code> function.</p>
<p>The general idea behind the iterative re-weighting is to assign the
inverse variance of the fitted residuals as component weights. This pattern
suggests that the more variable the residuals are from a particular data
source, the less weight it should receive. The
variances, and hence the final weights, are calculated according the
following algorithm:</p>
<ol style="list-style-type: decimal">
<li>Calculate the initial sums of squares (SS) given the initial
parameterization for all likelihood components. Assign the inverse SS
as the initial weight for all likelihood components, resulting in a total initial score of 1 for each component.</li>
<li>For each likelihood component, do an optimization run with
the initial weighted SS for that component set to 10 000. This run represents
a model fit where essentially only that component contributes to model
fitting, and therefore that component receives the best fit achievable.
Then estimate the residual variance using the resulting SS of that component divided
by the degrees of freedom (<span class="math inline">\(df^*\)</span>), i.e. <span class="math inline">\(\hat{\sigma}^2 = \frac{SS}{df^*}\)</span>.</li>
<li>After the optimization of each component separately, set the final weight
for each component to be the inverse of the estimated variance from the step above
(weight <span class="math inline">\(=1/\hat{\sigma}^2\)</span>).</li>
</ol>
<p>The number of non-zero data-points (<span class="math inline">\(df^{*}\)</span>) is used as a proxy for the degrees
of freedom. While this may be a satisfactory proxy for larger data sets, it could be
a gross overestimate of the degrees of freedom for smaller data sets.
In particular, if the survey indices are weighed on their own while the
annual recruitment is estimated, they could be over-fitted. In general,
problem such as these can be solved with component grouping. Component grouping
is achieved in step 2: likelihood components that should behave similarly, such
as survey indices representing similar age ranges, are weighted and optimized
together.</p>
<p>The <code>gadget.iterative</code> function implements the iterative reweighting heuristic and is invoked in the following manner:</p>
<div class="sourceCode" id="cb281"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb281-1"><a href="fitting-a-model-to-data.html#cb281-1"></a><span class="co">## In its current version, gadget.iterative needs to be run from within the</span></span>
<span id="cb281-2"><a href="fitting-a-model-to-data.html#cb281-2"></a><span class="co">## directory that contains the Gadget model</span></span>
<span id="cb281-3"><a href="fitting-a-model-to-data.html#cb281-3"></a>old &lt;-<span class="st"> </span><span class="kw">getwd</span>()</span>
<span id="cb281-4"><a href="fitting-a-model-to-data.html#cb281-4"></a><span class="kw">file.copy</span>(<span class="kw">sprintf</span>(<span class="st">&#39;%s/optinfofile&#39;</span>,<span class="st">&#39;data_provided&#39;</span>),gd)</span></code></pre></div>
<pre><code>## [1] TRUE</code></pre>
<div class="sourceCode" id="cb283"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb283-1"><a href="fitting-a-model-to-data.html#cb283-1"></a><span class="kw">setwd</span>(gd)</span>
<span id="cb283-2"><a href="fitting-a-model-to-data.html#cb283-2"></a></span>
<span id="cb283-3"><a href="fitting-a-model-to-data.html#cb283-3"></a><span class="co">## run gadget iterative</span></span>
<span id="cb283-4"><a href="fitting-a-model-to-data.html#cb283-4"></a><span class="co">## </span><span class="al">WARNING</span><span class="co">: Each time gadget.iterative runs with the given optinfofile,</span></span>
<span id="cb283-5"><a href="fitting-a-model-to-data.html#cb283-5"></a><span class="co">## it takes 11 mins to run on a reasonably fast computer with 2 cores.</span></span>
<span id="cb283-6"><a href="fitting-a-model-to-data.html#cb283-6"></a><span class="kw">timestamp</span>() </span></code></pre></div>
<pre><code>## ##------ Tue Nov 17 18:11:44 2020 ------##</code></pre>
<div class="sourceCode" id="cb285"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb285-1"><a href="fitting-a-model-to-data.html#cb285-1"></a>run &lt;-<span class="st"> </span><span class="kw">gadget.iterative</span>()</span>
<span id="cb285-2"><a href="fitting-a-model-to-data.html#cb285-2"></a><span class="kw">timestamp</span>()</span></code></pre></div>
<pre><code>## ##------ Tue Nov 17 18:15:35 2020 ------##</code></pre>
<p>This will start an iterative run that will estimate the weights for all likelihood
components, and run a final optimisation run with the resulting likelihood weights.
Penalising likelihood components, such as <code>boundlikelihood</code> and <code>understocking</code>, are
left as is. As the iterative reweighting requires several optimisation runs,
<code>gadget.iterative</code> tries to spread these runs across the available cores on your
computer. In the case of the number of cores lower than the number of runs, the excess
runs will wait until a core becomes available. The resulting parameter estimates are
then stored in a folder called <code>WGTS</code> in your model directory, where the file
<code>params.final</code> contains the final parameter estimate.</p>
<p>When running <code>gadget.iterative</code> with standard setting you assume that all
data sets have enough data to allow all parameters to be estimated without
overfitting the data. It is not always the case that this is appropriate.
For instance survey indices have in general only one data point per year,
step and size group, and when estimating annual recruitment this usually
leads overfitting of that particular component when heavily emphasized.
Similar problem can arise when only one year, or a few disjoint years,
worth of compositional data is supplied to the likelihood function. To
account for this issue the user can group similar likelihood components
together using the <code>grouping</code> argument in the <code>gadget.iterative</code> function.
When estimating annual recruitment, for example, this ensures that at least
two data points are available to estimate each of the recruitment parameters.
In the case of Ling, the survey indices were split into two groups, sizes 20
to 72 cm and 72 to 160 cm, and the compositional data from the commercial
trawl and gillnet fleets were grouped due to a low number of data points.</p>
<p>Note that when rerunning gadget.reiterative, it is best for file management
purposes to delete the old ‘WGTS’ folder before reruinning <code>gadget.iterative</code>,
for example by running <code>unlink("WGTS", recursive=TRUE)</code>.
Alternatively, if both sets of results should be kept, then the ‘WGTS’ folder
should be renamed by changing the default argument <code>wgts = 'WGTS'</code>. This is
especially important when visualizing model results in the next step using
<code>gadget.fit</code>.</p>
<div class="sourceCode" id="cb287"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb287-1"><a href="fitting-a-model-to-data.html#cb287-1"></a>run &lt;-<span class="st"> </span><span class="kw">gadget.iterative</span>(<span class="dt">grouping =</span> <span class="kw">list</span>(<span class="dt">sind1=</span><span class="kw">c</span>(<span class="st">&#39;si.len20&#39;</span>,<span class="st">&#39;si.len52&#39;</span>,<span class="st">&#39;si.len60&#39;</span>),</span>
<span id="cb287-2"><a href="fitting-a-model-to-data.html#cb287-2"></a>                                        <span class="dt">sind2=</span><span class="kw">c</span>(<span class="st">&#39;si.len72&#39;</span>,<span class="st">&#39;si.len80&#39;</span>,<span class="st">&#39;si.len92&#39;</span>,</span>
<span id="cb287-3"><a href="fitting-a-model-to-data.html#cb287-3"></a>                                                <span class="st">&#39;si.len100&#39;</span>),</span>
<span id="cb287-4"><a href="fitting-a-model-to-data.html#cb287-4"></a>                                        <span class="dt">comm=</span><span class="kw">c</span>(<span class="st">&#39;ldist.gil&#39;</span>,<span class="st">&#39;ldist.bmt&#39;</span>,</span>
<span id="cb287-5"><a href="fitting-a-model-to-data.html#cb287-5"></a>                                               <span class="st">&#39;aldist.gil&#39;</span>,<span class="st">&#39;aldist.bmt&#39;</span>)),</span>
<span id="cb287-6"><a href="fitting-a-model-to-data.html#cb287-6"></a>                        <span class="dt">wgts =</span> <span class="st">&#39;WGTS2&#39;</span>)</span></code></pre></div>
<p>Note that if a likelihood component is not present in the defined
grouping list it is assumed that the component is treated individually.
Sometimes this is not enough to prevent overfitting and therefore the
user can define a maximum weight of sorts by defining the minimum CV
for survey indices used for weight assignment. This is done using the
<code>cv.floor</code> argument:</p>
<div class="sourceCode" id="cb288"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb288-1"><a href="fitting-a-model-to-data.html#cb288-1"></a>run &lt;-<span class="st"> </span><span class="kw">gadget.iterative</span>(<span class="dt">cv.floor =</span> <span class="fl">0.2</span>,</span>
<span id="cb288-2"><a href="fitting-a-model-to-data.html#cb288-2"></a>                        <span class="dt">wgts =</span> <span class="st">&#39;WGTS3&#39;</span>)</span></code></pre></div>
<p>The <code>cv.floor</code> argument is often used after the final optimisation
run has crashed so it is convenient to be able to pick up the “thread”
where the run crashed and resume the final optimisation. The <code>resume.final</code>
switch allows for this and essentially only runs the last optimisation, thereby
assuming that the preceding steps have been completed:</p>
<div class="sourceCode" id="cb289"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb289-1"><a href="fitting-a-model-to-data.html#cb289-1"></a>run &lt;-<span class="st"> </span><span class="kw">gadget.iterative</span>(<span class="dt">resume.final =</span> <span class="ot">TRUE</span>, <span class="dt">cv.floor =</span> <span class="fl">0.2</span>,</span>
<span id="cb289-2"><a href="fitting-a-model-to-data.html#cb289-2"></a>                        <span class="dt">wgts =</span> <span class="st">&#39;WGTS3&#39;</span>)</span></code></pre></div>
<p>Related to <code>resume.final</code> there are the <code>run.final</code> and <code>run.serial</code> arguments
that instruct the function to whether to run the final optimisation from the
beginning and whether all optimisations should be run on a single core respectively.</p>
<p>Note for Windows users: the user needs to explicitly define a cluster for <code>gadget.iterative</code> to run in parallel, see <a href="https://www.r-bloggers.com/implementing-mclapply-on-windows-a-primer-on-embarrassingly-parallel-computation-on-multicore-systems-with-r/">here</a> for ways around this problem.</p>
<p>In post-hoc analyses of the effect of certain data sources on model fitting,
differential treatment of data is often investigated. For example, the effect
of a certain dataset can be analysed by omitting it from the estimation or changing
its grouping. <code>gadget.iterative</code> allows you to have multiple <code>WGTS</code> folders in the
same model directory by setting the <code>wgts</code> argument. In addition the user can
explicitly define (or remove) which component are to be used in the optimisation
using a combination of the <code>comp</code> and <code>inverse</code> arguments:</p>
<div class="sourceCode" id="cb290"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb290-1"><a href="fitting-a-model-to-data.html#cb290-1"></a><span class="co">## only want to fit to ldist.gil, all others discarded</span></span>
<span id="cb290-2"><a href="fitting-a-model-to-data.html#cb290-2"></a>run &lt;-<span class="st"> </span><span class="kw">gadget.iterative</span>(<span class="dt">comp =</span> <span class="st">&#39;ldist.gil&#39;</span>,</span>
<span id="cb290-3"><a href="fitting-a-model-to-data.html#cb290-3"></a>                        <span class="dt">wgts =</span> <span class="st">&#39;WGTS3&#39;</span>)</span>
<span id="cb290-4"><a href="fitting-a-model-to-data.html#cb290-4"></a></span>
<span id="cb290-5"><a href="fitting-a-model-to-data.html#cb290-5"></a><span class="co">## remove ldist.gil, all others kept</span></span>
<span id="cb290-6"><a href="fitting-a-model-to-data.html#cb290-6"></a>run &lt;-<span class="st"> </span><span class="kw">gadget.iterative</span>(<span class="dt">comp =</span> <span class="st">&#39;ldist.gil&#39;</span>, </span>
<span id="cb290-7"><a href="fitting-a-model-to-data.html#cb290-7"></a>                        <span class="dt">inverse =</span> <span class="ot">TRUE</span>,</span>
<span id="cb290-8"><a href="fitting-a-model-to-data.html#cb290-8"></a>                        <span class="dt">wgts =</span> <span class="st">&#39;WGTS3&#39;</span>)</span></code></pre></div>
</div>
<div id="visualize-gadget-statistical-model-fit" class="section level2">
<h2><span class="header-section-number">7.7</span> Visualize Gadget statistical model fit</h2>
<p>To obtain information on the model fit and properties of the model, one can
use the <code>gadget.fit</code> function to query the model and return conveniently
structured output. Notice that there is a default argument in <code>gadget.fit</code>
that matches <code>gadget.reiterative</code>: the <code>wgts = 'WGTS'</code> argument. This means that
by default gadget.fit will load the reiterative results stored under ‘WGTS’,
but this can be changed. Here we load results from the first run of
<code>gadget.iterative</code> where no grouping was implemented.</p>
<div class="sourceCode" id="cb291"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb291-1"><a href="fitting-a-model-to-data.html#cb291-1"></a><span class="kw">setwd</span>(gd)  <span class="co"># Make sure we are in gd first</span></span>
<span id="cb291-2"><a href="fitting-a-model-to-data.html#cb291-2"></a>fit &lt;-<span class="st"> </span><span class="kw">gadget.fit</span>()</span></code></pre></div>
<pre><code>## [1] &quot;Reading input data&quot;
## [1] &quot;Running Gadget&quot;
## [1] &quot;Reading output files&quot;
## [1] &quot;Gathering results&quot;
## [1] &quot;Merging input and output&quot;</code></pre>
<div class="sourceCode" id="cb293"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb293-1"><a href="fitting-a-model-to-data.html#cb293-1"></a><span class="kw">theme_set</span>(<span class="kw">theme_light</span>()) <span class="co">## set the plot theme (optional)</span></span>
<span id="cb293-2"><a href="fitting-a-model-to-data.html#cb293-2"></a></span>
<span id="cb293-3"><a href="fitting-a-model-to-data.html#cb293-3"></a><span class="kw">library</span>(patchwork)  <span class="co">## optional packages </span></span>
<span id="cb293-4"><a href="fitting-a-model-to-data.html#cb293-4"></a>scale_fill_crayola &lt;-<span class="st"> </span><span class="cf">function</span>(<span class="dt">n =</span> <span class="dv">100</span>, ...) {</span>
<span id="cb293-5"><a href="fitting-a-model-to-data.html#cb293-5"></a>  </span>
<span id="cb293-6"><a href="fitting-a-model-to-data.html#cb293-6"></a>  <span class="co"># taken from RColorBrewer::brewer.pal(12, &quot;Paired&quot;)</span></span>
<span id="cb293-7"><a href="fitting-a-model-to-data.html#cb293-7"></a>  pal &lt;-<span class="st"> </span><span class="kw">c</span>(<span class="st">&quot;#A6CEE3&quot;</span>, <span class="st">&quot;#1F78B4&quot;</span>, <span class="st">&quot;#B2DF8A&quot;</span>, <span class="st">&quot;#33A02C&quot;</span>,</span>
<span id="cb293-8"><a href="fitting-a-model-to-data.html#cb293-8"></a>           <span class="st">&quot;#FB9A99&quot;</span>, <span class="st">&quot;#E31A1C&quot;</span>, <span class="st">&quot;#FDBF6F&quot;</span>, <span class="st">&quot;#FF7F00&quot;</span>,</span>
<span id="cb293-9"><a href="fitting-a-model-to-data.html#cb293-9"></a>           <span class="st">&quot;#CAB2D6&quot;</span>, <span class="st">&quot;#6A3D9A&quot;</span>, <span class="st">&quot;#FFFF99&quot;</span>, <span class="st">&quot;#B15928&quot;</span>)</span>
<span id="cb293-10"><a href="fitting-a-model-to-data.html#cb293-10"></a>  pal &lt;-<span class="st"> </span><span class="kw">rep</span>(pal, n)</span>
<span id="cb293-11"><a href="fitting-a-model-to-data.html#cb293-11"></a>  ggplot2<span class="op">::</span><span class="kw">scale_fill_manual</span>(<span class="dt">values =</span> pal, ...)</span>
<span id="cb293-12"><a href="fitting-a-model-to-data.html#cb293-12"></a>  </span>
<span id="cb293-13"><a href="fitting-a-model-to-data.html#cb293-13"></a>}</span></code></pre></div>
<p>The <code>fit</code> object is essentially a list of data.frames that contain the likelihood data merged with the model output.</p>
<div class="sourceCode" id="cb294"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb294-1"><a href="fitting-a-model-to-data.html#cb294-1"></a>fit <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">names</span>()</span></code></pre></div>
<pre><code>##  [1] &quot;sidat&quot;             &quot;resTable&quot;          &quot;nesTable&quot;         
##  [4] &quot;suitability&quot;       &quot;stock.recruitment&quot; &quot;res.by.year&quot;      
##  [7] &quot;stomachcontent&quot;    &quot;likelihoodsummary&quot; &quot;catchdist.fleets&quot; 
## [10] &quot;stockdist&quot;         &quot;SS&quot;                &quot;stock.full&quot;       
## [13] &quot;stock.std&quot;         &quot;stock.prey&quot;        &quot;fleet.info&quot;       
## [16] &quot;predator.prey&quot;     &quot;params&quot;            &quot;catchstatistics&quot;</code></pre>
<p>and one can access those data.frames simply by calling their name:</p>
<div class="sourceCode" id="cb296"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb296-1"><a href="fitting-a-model-to-data.html#cb296-1"></a>fit<span class="op">$</span>sidat</span></code></pre></div>
<pre><code>## [90m# A tibble: 238 x 20[39m
##    name   year  step  area label number intercept slope   sse stocknames sitype
##    [3m[90m&lt;chr&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m  [3m[90m&lt;dbl&gt;[39m[23m     [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;dbl&gt;[39m[23m [3m[90m&lt;chr&gt;[39m[23m      [3m[90m&lt;chr&gt;[39m[23m 
## [90m 1[39m si.l…  [4m1[24m985     2     1 len1… 1.06[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 2[39m si.l…  [4m1[24m986     2     1 len1… 1.50[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 3[39m si.l…  [4m1[24m987     2     1 len1… 2.12[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 4[39m si.l…  [4m1[24m988     2     1 len1… 2.92[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 5[39m si.l…  [4m1[24m989     2     1 len1… 3.81[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 6[39m si.l…  [4m1[24m990     2     1 len1… 4.67[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 7[39m si.l…  [4m1[24m991     2     1 len1… 5.41[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 8[39m si.l…  [4m1[24m992     2     1 len1… 5.99[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m 9[39m si.l…  [4m1[24m993     2     1 len1… 6.49[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m10[39m si.l…  [4m1[24m994     2     1 len1… 6.84[90me[39m6     -[31m11[39m[31m.[39m[31m7[39m     1  20.2 [90m&quot;[39mlingimm\… lengt…
## [90m# … with 228 more rows, and 9 more variables: fittype [3m[90m&lt;chr&gt;[90m[23m, length [3m[90m&lt;chr&gt;[90m[23m,[39m
## [90m#   age [3m[90m&lt;lgl&gt;[90m[23m, survey [3m[90m&lt;lgl&gt;[90m[23m, fleet [3m[90m&lt;lgl&gt;[90m[23m, observed [3m[90m&lt;dbl&gt;[90m[23m, lower [3m[90m&lt;int&gt;[90m[23m,[39m
## [90m#   upper [3m[90m&lt;int&gt;[90m[23m, predict [3m[90m&lt;dbl&gt;[90m[23m[39m</code></pre>
<p>For further information on what the relevant data.frames contain refer to the help page for <code>gadget.fit</code>.</p>
<p>In addition a plot routine for the <code>fit</code> object is implement in Rgadget. The input to the <code>plot</code> function is simply the <code>gadget.fit</code> object, the data set one wants to plot and the type. The default plot is a survey index plot:</p>
<div class="sourceCode" id="cb298"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb298-1"><a href="fitting-a-model-to-data.html#cb298-1"></a><span class="kw">plot</span>(fit)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-24-1.png" width="672" /></p>
<p>To produce a likelihood summary:</p>
<div class="sourceCode" id="cb299"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb299-1"><a href="fitting-a-model-to-data.html#cb299-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;summary&#39;</span>)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-25-1.png" width="672" /></p>
<p>A weighted summary plot:</p>
<div class="sourceCode" id="cb300"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb300-1"><a href="fitting-a-model-to-data.html#cb300-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;summary&#39;</span>,<span class="dt">type =</span> <span class="st">&#39;weighted&#39;</span>)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-26-1.png" width="672" /></p>
<p>and a pie chart of likelihood components:</p>
<div class="sourceCode" id="cb301"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb301-1"><a href="fitting-a-model-to-data.html#cb301-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;summary&#39;</span>,<span class="dt">type=</span><span class="st">&#39;pie&#39;</span>)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-27-1.png" width="672" /></p>
<p>To plot the fit to catch proportions (either length or age) you simply do:</p>
<div class="sourceCode" id="cb302"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb302-1"><a href="fitting-a-model-to-data.html#cb302-1"></a>tmp &lt;-<span class="st"> </span><span class="kw">plot</span>(fit,<span class="dt">data =</span> <span class="st">&#39;catchdist.fleets&#39;</span>)</span>
<span id="cb302-2"><a href="fitting-a-model-to-data.html#cb302-2"></a><span class="kw">names</span>(tmp)</span></code></pre></div>
<pre><code>## [1] &quot;aldist.bmt&quot;  &quot;aldist.gil&quot;  &quot;aldist.lln&quot;  &quot;aldist.surv&quot; &quot;ldist.bmt&quot;  
## [6] &quot;ldist.gil&quot;   &quot;ldist.lln&quot;   &quot;ldist.surv&quot;</code></pre>
<p>and then plot them one by one:</p>
<div class="sourceCode" id="cb304"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb304-1"><a href="fitting-a-model-to-data.html#cb304-1"></a>tmp<span class="op">$</span>aldist.surv</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-29-1.png" width="672" /></p>
<div class="sourceCode" id="cb305"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb305-1"><a href="fitting-a-model-to-data.html#cb305-1"></a>tmp<span class="op">$</span>ldist.surv</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-30-1.png" width="672" /></p>
<p>One can also produce bubble plots</p>
<div class="sourceCode" id="cb306"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb306-1"><a href="fitting-a-model-to-data.html#cb306-1"></a>bubbles &lt;-<span class="st"> </span><span class="kw">plot</span>(fit,<span class="dt">data =</span> <span class="st">&#39;catchdist.fleets&#39;</span>,<span class="dt">type=</span><span class="st">&#39;bubble&#39;</span>)</span>
<span id="cb306-2"><a href="fitting-a-model-to-data.html#cb306-2"></a><span class="kw">names</span>(bubbles)</span></code></pre></div>
<pre><code>## [1] &quot;ldist&quot;  &quot;aldist&quot;</code></pre>
<p>Age bubbles</p>
<div class="sourceCode" id="cb308"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb308-1"><a href="fitting-a-model-to-data.html#cb308-1"></a>bubbles<span class="op">$</span>aldist</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-32-1.png" width="672" /></p>
<p>Length bubbles</p>
<div class="sourceCode" id="cb309"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb309-1"><a href="fitting-a-model-to-data.html#cb309-1"></a>bubbles<span class="op">$</span>ldist</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-33-1.png" width="672" /></p>
<p>One can also illustrate the fit to growth in the model:</p>
<div class="sourceCode" id="cb310"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb310-1"><a href="fitting-a-model-to-data.html#cb310-1"></a>grplot &lt;-<span class="st"> </span><span class="kw">plot</span>(fit,<span class="dt">data =</span> <span class="st">&#39;catchdist.fleets&#39;</span>,<span class="dt">type=</span><span class="st">&#39;growth&#39;</span>)</span>
<span id="cb310-2"><a href="fitting-a-model-to-data.html#cb310-2"></a><span class="kw">names</span>(grplot)</span></code></pre></div>
<pre><code>## [1] &quot;aldist.bmt&quot;  &quot;aldist.gil&quot;  &quot;aldist.lln&quot;  &quot;aldist.surv&quot;</code></pre>
<p>Illstrate the fit to the autumn survey</p>
<div class="sourceCode" id="cb312"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb312-1"><a href="fitting-a-model-to-data.html#cb312-1"></a>grplot<span class="op">$</span>aldist.surv</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-35-1.png" width="672" /></p>
<p>And the fit to maturity data:</p>
<div class="sourceCode" id="cb313"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb313-1"><a href="fitting-a-model-to-data.html#cb313-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;stockdist&#39;</span>)</span></code></pre></div>
<pre><code>## $matp.surv</code></pre>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-36-1.png" width="672" /></p>
<p>And selection by year and step</p>
<div class="sourceCode" id="cb315"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb315-1"><a href="fitting-a-model-to-data.html#cb315-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&quot;suitability&quot;</span>)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-37-1.png" width="672" /></p>
<p>Age age compostion</p>
<div class="sourceCode" id="cb316"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb316-1"><a href="fitting-a-model-to-data.html#cb316-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;stock.std&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">scale_fill_crayola</span>()</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-38-1.png" width="672" /></p>
<p>And the standard ICES plots</p>
<div class="sourceCode" id="cb317"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb317-1"><a href="fitting-a-model-to-data.html#cb317-1"></a><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;res.by.year&#39;</span>,<span class="dt">type=</span><span class="st">&#39;total&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&#39;none&#39;</span>) <span class="op">+</span></span>
<span id="cb317-2"><a href="fitting-a-model-to-data.html#cb317-2"></a><span class="st">  </span><span class="kw">plot</span>(fit,<span class="dt">data=</span><span class="st">&#39;res.by.year&#39;</span>,<span class="dt">type=</span><span class="st">&#39;F&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&#39;none&#39;</span>) <span class="op">+</span></span>
<span id="cb317-3"><a href="fitting-a-model-to-data.html#cb317-3"></a><span class="st">  </span><span class="kw">plot</span>(fit,<span class="dt">data =</span> <span class="st">&#39;res.by.year&#39;</span>,<span class="dt">type=</span><span class="st">&#39;catch&#39;</span>) <span class="op">+</span><span class="st"> </span><span class="kw">theme</span>(<span class="dt">legend.position =</span> <span class="st">&#39;none&#39;</span>) <span class="op">+</span></span>
<span id="cb317-4"><a href="fitting-a-model-to-data.html#cb317-4"></a><span class="st">  </span><span class="kw">plot</span>(fit, <span class="dt">data=</span><span class="st">&#39;res.by.year&#39;</span>,<span class="dt">type=</span><span class="st">&#39;rec&#39;</span>)</span></code></pre></div>
<p><img src="day3_fitlingmodel_files/figure-html/unnamed-chunk-39-1.png" width="672" /></p>
<div id="exercise-6" class="section level4">
<h4><span class="header-section-number">7.7.0.1</span> Exercise</h4>
<ul>
<li>Try plotting the catchabilities on the normal scale (exponentiated, not log as given) across ages for each survey. What shape are they when plotted?</li>
<li>What information is stored under fit$SS?</li>
<li>Try changing the grouping structure above to one that makes more sense to you. Do model results fit any better?</li>
</ul>

</div>
</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="building-complex-gadget-models.html" class="navigation navigation-prev " aria-label="Previous page"><i class="fa fa-angle-left"></i></a>
<a href="defining-multi-area-models.html" class="navigation navigation-next " aria-label="Next page"><i class="fa fa-angle-right"></i></a>
    </div>
  </div>
<script src="assets/gitbook-2.6.7/js/app.min.js"></script>
<script src="assets/gitbook-2.6.7/js/lunr.js"></script>
<script src="assets/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="assets/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="assets/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/hafro/gadget-course/edit/master/day3_fitlingmodel.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": "https://github.com/hafro/gadget-course/blob/master/day3_fitlingmodel.Rmd",
"text": null
},
"download": null,
"toc": {
"collapse": "section"
}
});
});
</script>

<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    var src = "true";
    if (src === "" || src === "true") src = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML";
    if (location.protocol !== "file:")
      if (/^https?:/.test(src))
        src = src.replace(/^https?:/, '');
    script.src = src;
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>
</body>

</html>

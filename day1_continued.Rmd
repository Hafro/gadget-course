---
title: "Adding components to the model"
output: 
  html_document:
    fig_height: 4
    fig_width: 8
    highlight: haddock
    theme: united
    toc: yes
    toc_float: yes
bibliography: library.bib
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(Rgadget)
schedule <- 
  expand.grid(year = 1:10, step = 1:4) %>% 
  arrange(year)
gd <- gadget.variant.dir('simple_model')
```

## Gadget variables 

It can be tedious to change all the input files whenever you want to try a different value for a certain input parameter. For example if you want to specify natural mortality as some thing else than 0 you can always do:
```{r}
gadgetstock('simple_stock',gd) %>% 
  gadget_update('naturalmortality',0.2)
```
And if you want to try many version of natural mortality you can obviously repeat this process for different values of M. There is however a more convenient approach to do this, namely Gadget switches or parameters. A Gadget parameter can be inserted instead of any number in the input file (apart from likelihood data), and are marked with the `#` character. So for the case of natural mortality we can now update the stock file to include a Gadget parameter by:

```{r}
gadgetstock('simple_stock',gd) %>% 
  gadget_update('naturalmortality',"#M")
```

And now we see that the value for natural mortality has been changed from 0 to `#M`. Now write this to file and rerun run Gadget.
```{r echo=FALSE}
gadgetstock('simple_stock',gd) %>% 
  gadget_update('naturalmortality','#M') %>% 
  write.gadget.file(gd)

callGadget(s=1,main='main',ignore.stderr = FALSE,log = 'simple_log')
```

After running this, assuming we did everything correctly, we should see that the file in the directory called `params.out` is no longer empty:
```{r echo=FALSE}
read_lines('simple_model/params.out') %>% 
  paste(collapse = '\n') %>% 
  cat()
```

This file is generated by Gadget based on the switches it encounters when reading in the input files. It lists all parameters, their value as used in the simulation, upper and lower bounds and whether the parameter should optimised (more on that later). You then simply just change the value for M and re-run Gadget by supplying the parameter file as input. This can either be done by manually editing the parameter file or using the `init_guess` function:
```{r}
read.gadget.parameters('simple_model/params.out') %>% 
  init_guess('M',value = 0.2) %>% 
  write.gadget.parameters(file = 'simple_model/params.in')

callGadget(s=1,i='params.in')
```

Note that when supplying a parameter input you use the `i` argument in `callGadget`. 

Gadget parameters have a few more tricks up their sleeves. Notably you can apply functions or formulas to the parameter. For instance if you want multiply the value of `M` by 0.1 you can write that as:
```
(* 0.1 #M)
```
Note that functions and formulas are contained within round brackets, so that this
structure equates to `0.1*M`.

Similarly if you need to log transform your variable as `log(M)`, you can use:
```
(log #M)
```
 and these can be chained together:
```
(log (* 0.1 #M))
```
equates to `log(0.1*M)`. This allows you to apply fairly elaborate functions to the parameter. And as in the case of variables formulas can then be inserted instead of numbers. 


These formulas can be fairly complex and Rgadget provides mechanisms to manipulate Gadget formulae, both allowing you to evaluate the formula using `parse.gadget.formula` and transform a R statement with `to.gadget.formulae`:

```{r}
## R expression to Gadget formula
to.gadget.formulae(quote((1+exp(a*b))))

## Gadget formula to a R expression
parse.gadget.formulae('(* #a #b)')

## evaluate expression
parse.gadget.formulae('(* #a #b)') %>% 
  eval(list(a=7,b=6))
```

For instance if you want the mean length at age, in for instance the initial conditions, to be based on the Von Bertanlanfy growth function:
$$l_a = L_\infty(1 - e^{-k(a - a_0)}) $$
you can do that for age 3 as an example using the `to.gadget.formulae` in the following manner:

```{r}
to.gadget.formulae(quote(linf*(1-exp(-1*k(3-a0)))))
```



#### Exercise
* Change the initial conditions in such a way you can control both the initial number of fish and the natural mortality using the parameter file. What happens to your stock when you change these values?
* Play around with the Gadget formulae functions, e.g. parse and evaluate the following formula at $\alpha = 0.1$ and $l_{50} = 75$ :
```
 (/ 1 (+ 1 (exp (* (* -1 #alpha) (- 50 #l50)))))
```


## Fleet operations
Fleet operations are defined as a separate model component. 

```{r}
effort <- 
  structure(data.frame(year=schedule$year,step=2,area=1,number=1),
            area_group = list(`1` = 1)) 


gadgetfleet('Modelfiles/fleet',gd,missingOkay = TRUE) %>% 
    gadget_update('linearfleet',
                  name = 'simple_fleet',
                  suitability = 
                    list(simple_stock=list(type='function',suit_func = 'constant',value=0.2)),
                  data = effort) %>% 
  write.gadget.file(gd)
```


